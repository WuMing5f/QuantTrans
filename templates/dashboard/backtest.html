<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­–ç•¥å›æµ‹ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1e1e1e;
            color: #fff;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4CAF50;
        }
        .header h1 {
            margin: 0;
            color: #fff;
        }
        .nav-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .nav-btn:hover {
            background-color: #45a049;
        }
        .backtest-form {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #555;
            background-color: #1e1e1e;
            color: #fff;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .strategy-params {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 4px;
            margin-top: 15px;
            border: 1px solid #444;
            display: none;
        }
        .strategy-params.active {
            display: block;
        }
        .strategy-params h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        .param-group {
            margin-bottom: 0;
        }
        .param-group label {
            display: block;
            color: #ccc;
            font-size: 0.9em;
        }
        .param-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #555;
            background-color: #2d2d2d;
            color: #fff;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn-run {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
        }
        .btn-run:hover {
            background-color: #45a049;
        }
        .btn-run:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .result-container {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 30px;
            margin-top: 30px;
            display: none;
        }
        .result-container.active {
            display: block;
        }
        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-label {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-value.negative {
            color: #ef5350;
        }
        .result-chart {
            width: 100% !important;
            height: 500px !important;
            min-height: 500px;
            background-color: #1e1e1e;
            border-radius: 4px;
            margin-top: 20px;
            position: relative;
            display: block !important;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
            display: none;
        }
        .loading.active {
            display: block;
        }
        .error {
            background-color: #ef5350;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
        }
        .error.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ç­–ç•¥å›æµ‹ç³»ç»Ÿ</h1>
            <a href="{% url 'index' %}" class="nav-btn">è¿”å›é¦–é¡µ</a>
        </div>

        <div class="backtest-form">
            <form id="backtestForm" onsubmit="return false;">
                {% csrf_token %}
                <div class="form-row">
                    <div class="form-group">
                        <label>é€‰æ‹©æ ‡çš„</label>
                        <select name="symbol" id="symbol" required>
                            <option value="">è¯·é€‰æ‹©æ ‡çš„</option>
                            {% for item in instruments %}
                            <option value="{{ item.instrument.symbol }}" 
                                    data-min-date="{{ item.min_date|date:'Y-m-d' }}" 
                                    data-max-date="{{ item.max_date|date:'Y-m-d' }}"
                                    data-count="{{ item.count }}">
                                {{ item.instrument.symbol }} - {{ item.instrument.name }} 
                                ({{ item.min_date|date:'Y-m-d' }} è‡³ {{ item.max_date|date:'Y-m-d' }}, {{ item.count }}æ¡)
                            </option>
                            {% endfor %}
                        </select>
                        <div id="symbolDataRange" style="margin-top: 5px; color: #4CAF50; font-size: 0.9em; display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label>é€‰æ‹©ç­–ç•¥</label>
                        <select name="strategy" id="strategy" required>
                            <option value="">è¯·é€‰æ‹©ç­–ç•¥</option>
                            {% for key, strategy in strategies.items %}
                            <option value="{{ key }}" data-description="{{ strategy.description }}">{{ strategy.name }} - {{ strategy.description }}</option>
                            {% endfor %}
                        </select>
                        <div id="strategyDescription" style="margin-top: 8px; color: #999; font-size: 0.9em; display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label>å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" name="start_date" id="start_date" required>
                    </div>
                    <div class="form-group">
                        <label>ç»“æŸæ—¥æœŸ</label>
                        <input type="date" name="end_date" id="end_date" required>
                    </div>
                    <div class="form-group">
                        <label>åˆå§‹èµ„é‡‘</label>
                        <input type="number" name="initial_cash" id="initial_cash" value="100000" min="1000" step="1000" required>
                    </div>
                    <div class="form-group">
                        <label>æ‰‹ç»­è´¹ç‡ (%)</label>
                        <input type="number" name="commission" id="commission" value="0.1" min="0" max="10" step="0.01" required>
                    </div>
                </div>

                <div class="strategy-params" id="strategyParams">
                    <!-- ç­–ç•¥å‚æ•°å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn-run" id="btnRun">å¼€å§‹å›æµ‹</button>
                    <button type="button" class="btn-run" id="btnOptimize" style="background-color: #2196F3;">ğŸ” å‚æ•°ä¼˜åŒ–</button>
                </div>
            </form>
        </div>

        <div class="loading" id="loading">
            <p>æ­£åœ¨è¿è¡Œå›æµ‹ï¼Œè¯·ç¨å€™...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="result-container" id="resultContainer">
            <h2>å›æµ‹ç»“æœ</h2>
            <div class="result-stats" id="resultStats">
                <!-- ç»Ÿè®¡ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
            <div class="result-chart" id="resultChart"></div>
        </div>
    </div>

    <script>
        console.log('Backtest page loaded');
        const strategies = {{ strategies_json|safe }};
        
        // ç­–ç•¥å‚æ•°è¯¦ç»†è¯´æ˜
        const paramDescriptions = {
            'fast_period': {
                title: 'çŸ­æœŸå‡çº¿å‘¨æœŸ',
                description: 'è®¡ç®—çŸ­æœŸç§»åŠ¨å¹³å‡çº¿çš„å¤©æ•°ã€‚æ•°å€¼è¶Šå°è¶Šæ•æ„Ÿï¼Œå¸¸ç”¨å€¼ï¼š5ï¼ˆæ—¥Kï¼‰ã€12ï¼ˆæ—¥Kï¼‰ã€‚çŸ­æœŸå‡çº¿èƒ½å¿«é€Ÿååº”ä»·æ ¼å˜åŒ–ã€‚'
            },
            'slow_period': {
                title: 'é•¿æœŸå‡çº¿å‘¨æœŸ',
                description: 'è®¡ç®—é•¿æœŸç§»åŠ¨å¹³å‡çº¿çš„å¤©æ•°ã€‚æ•°å€¼è¶Šå¤§è¶Šå¹³æ»‘ï¼Œå¸¸ç”¨å€¼ï¼š20ï¼ˆæ—¥Kï¼‰ã€26ï¼ˆæ—¥Kï¼‰ã€60ï¼ˆæ—¥Kï¼‰ã€‚é•¿æœŸå‡çº¿ä»£è¡¨è¶‹åŠ¿æ–¹å‘ã€‚'
            },
            'mid_period': {
                title: 'ä¸­æœŸå‡çº¿å‘¨æœŸ',
                description: 'è®¡ç®—ä¸­æœŸç§»åŠ¨å¹³å‡çº¿çš„å¤©æ•°ã€‚ä»‹äºçŸ­æœŸå’Œé•¿æœŸä¹‹é—´ï¼Œå¸¸ç”¨å€¼ï¼š10ï¼ˆæ—¥Kï¼‰ã€20ï¼ˆæ—¥Kï¼‰ã€‚ç”¨äºè¿‡æ»¤çŸ­æœŸæ³¢åŠ¨ã€‚'
            },
            'period': {
                title: 'å‘¨æœŸå‚æ•°',
                description: 'æŠ€æœ¯æŒ‡æ ‡çš„ç»Ÿè®¡å‘¨æœŸã€‚å¯¹äºRSIï¼šå¸¸ç”¨14ï¼ŒèŒƒå›´6-21ï¼›å¯¹äºå¸ƒæ—å¸¦ï¼šå¸¸ç”¨20ï¼ŒèŒƒå›´10-30ï¼›å¯¹äºå‡çº¿ï¼šå¸¸ç”¨20ï¼ŒèŒƒå›´5-60ã€‚å‘¨æœŸè¶Šé•¿è¶Šç¨³å®šä½†ååº”è¶Šæ…¢ã€‚'
            },
            'signal_period': {
                title: 'ä¿¡å·çº¿å‘¨æœŸ',
                description: 'MACDç­–ç•¥ä¸­ä¿¡å·çº¿çš„å¹³æ»‘å‘¨æœŸã€‚å¸¸ç”¨å€¼ï¼š9ã€‚ç”¨äºäº§ç”Ÿä¹°å…¥/å–å‡ºä¿¡å·ï¼Œæ•°å€¼è¶Šå°ä¿¡å·è¶Šå¤šä½†å¯èƒ½äº§ç”Ÿå™ªéŸ³ã€‚'
            },
            'oversold': {
                title: 'è¶…å–é˜ˆå€¼',
                description: 'RSIæŒ‡æ ‡çš„è¶…å–çº¿ã€‚å¸¸ç”¨å€¼ï¼š30ï¼ˆRSIèŒƒå›´0-100ï¼‰ã€‚å½“RSIä½äºæ­¤å€¼æ—¶ï¼Œè®¤ä¸ºè‚¡ç¥¨è¢«è¿‡åº¦å–å‡ºï¼Œå¯èƒ½å‡ºç°åå¼¹ï¼Œè§¦å‘ä¹°å…¥ä¿¡å·ã€‚å¯è°ƒæ•´èŒƒå›´ï¼š20-40ã€‚'
            },
            'overbought': {
                title: 'è¶…ä¹°é˜ˆå€¼',
                description: 'RSIæŒ‡æ ‡çš„è¶…ä¹°çº¿ã€‚å¸¸ç”¨å€¼ï¼š70ï¼ˆRSIèŒƒå›´0-100ï¼‰ã€‚å½“RSIé«˜äºæ­¤å€¼æ—¶ï¼Œè®¤ä¸ºè‚¡ç¥¨è¢«è¿‡åº¦ä¹°å…¥ï¼Œå¯èƒ½å›è°ƒï¼Œè§¦å‘å–å‡ºä¿¡å·ã€‚å¯è°ƒæ•´èŒƒå›´ï¼š60-80ã€‚'
            },
            'devfactor': {
                title: 'æ ‡å‡†å·®å€æ•°',
                description: 'å¸ƒæ—å¸¦å®½åº¦å‚æ•°ã€‚å¸¸ç”¨å€¼ï¼š2.0ã€‚æ•°å€¼è¶Šå¤§ï¼Œå¸ƒæ—å¸¦è¶Šå®½ï¼Œä¹°å…¥/å–å‡ºä¿¡å·è¶Šå°‘ä½†æ›´å¯é ã€‚å¸¸ç”¨èŒƒå›´ï¼š1.5-2.5ã€‚æ•°å€¼å°=æ•æ„Ÿï¼Œæ•°å€¼å¤§=ä¿å®ˆã€‚'
            },
            'threshold': {
                title: 'åç¦»é˜ˆå€¼',
                description: 'ä»·æ ¼åç¦»å‡çº¿çš„ç™¾åˆ†æ¯”é˜ˆå€¼ï¼ˆå°æ•°å½¢å¼ï¼‰ã€‚ä¾‹å¦‚0.02è¡¨ç¤º2%ï¼Œ0.05è¡¨ç¤º5%ã€‚å½“ä»·æ ¼ä½äºå‡çº¿æ­¤ç™¾åˆ†æ¯”æ—¶ä¹°å…¥ï¼Œé«˜äºæ­¤ç™¾åˆ†æ¯”æ—¶å–å‡ºã€‚å¸¸ç”¨èŒƒå›´ï¼š0.01-0.05ã€‚'
            },
            'lookback': {
                title: 'å›çœ‹å‘¨æœŸ',
                description: 'è®¡ç®—æ³¢åŠ¨ç‡å’Œæˆäº¤é‡çš„å›çœ‹å¤©æ•°ã€‚ç”¨äºVCPç­–ç•¥ä¸­è®¡ç®—å†å²æ³¢åŠ¨ç‡å’Œæˆäº¤é‡åŸºå‡†ã€‚å¸¸ç”¨å€¼ï¼š20ã€‚å‘¨æœŸè¶Šé•¿ï¼ŒåŸºå‡†è¶Šç¨³å®šä½†ååº”è¶Šæ…¢ã€‚'
            },
            'contraction_ratio': {
                title: 'æ³¢åŠ¨æ”¶ç¼©æ¯”ä¾‹',
                description: 'VCPç­–ç•¥ä¸­æ³¢åŠ¨æ”¶ç¼©çš„é˜ˆå€¼ï¼ˆå°æ•°å½¢å¼ï¼‰ã€‚ä¾‹å¦‚0.7è¡¨ç¤ºå½“å‰æ³¢åŠ¨å°äºå†å²æ³¢åŠ¨çš„70%æ—¶è®¤ä¸ºå‘ç”Ÿæ”¶ç¼©ã€‚å¸¸ç”¨å€¼ï¼š0.6-0.8ã€‚æ•°å€¼è¶Šå°è¦æ±‚è¶Šä¸¥æ ¼ã€‚'
            },
            'volume_ratio': {
                title: 'æˆäº¤é‡æ”¶ç¼©æ¯”ä¾‹',
                description: 'VCPç­–ç•¥ä¸­æˆäº¤é‡æ”¶ç¼©çš„é˜ˆå€¼ï¼ˆå°æ•°å½¢å¼ï¼‰ã€‚ä¾‹å¦‚0.8è¡¨ç¤ºå½“å‰æˆäº¤é‡å°äºå†å²å‡é‡çš„80%æ—¶è®¤ä¸ºæˆäº¤é‡æ”¶ç¼©ã€‚å¸¸ç”¨å€¼ï¼š0.7-0.9ã€‚æ•°å€¼è¶Šå°è¦æ±‚è¶Šä¸¥æ ¼ã€‚'
            },
            'breakout_threshold': {
                title: 'çªç ´é˜ˆå€¼',
                description: 'ä»·æ ¼çªç ´çš„ç™¾åˆ†æ¯”é˜ˆå€¼ï¼ˆå€æ•°å½¢å¼ï¼‰ã€‚ä¾‹å¦‚1.02è¡¨ç¤ºä»·æ ¼çªç ´å‰é«˜çš„2%æ—¶è§¦å‘ä¹°å…¥ã€‚å¸¸ç”¨å€¼ï¼š1.01-1.05ã€‚æ•°å€¼è¶Šå¤§è¦æ±‚çªç ´è¶Šå¼ºã€‚'
            },
            'pattern_type': {
                title: 'å½¢æ€ç±»å‹',
                description: 'èœ¡çƒ›å›¾ç­–ç•¥ä¸­è¦è¯†åˆ«çš„å½¢æ€ç±»å‹ã€‚å¯é€‰å€¼ï¼šallï¼ˆæ‰€æœ‰å½¢æ€ï¼‰ã€hammerï¼ˆé”¤å­çº¿ï¼‰ã€engulfingï¼ˆåæ²¡å½¢æ€ï¼‰ã€dojiï¼ˆåå­—æ˜Ÿï¼‰ã€‚æ¨èä½¿ç”¨allä»¥æ•æ‰æ›´å¤šæœºä¼šã€‚'
            },
            'confirmation_period': {
                title: 'ç¡®è®¤å‘¨æœŸ',
                description: 'èœ¡çƒ›å›¾å½¢æ€å‡ºç°åï¼Œéœ€è¦ç­‰å¾…å¤šå°‘ä¸ªäº¤æ˜“æ—¥ç¡®è®¤ã€‚ç”¨äºè¿‡æ»¤è™šå‡ä¿¡å·ã€‚å¸¸ç”¨å€¼ï¼š1-3ã€‚å‘¨æœŸè¶Šé•¿ä¿¡å·è¶Šå¯é ä½†å¯èƒ½é”™è¿‡æœ€ä½³å…¥åœºç‚¹ã€‚'
            },
            'min_body_ratio': {
                title: 'æœ€å°å®ä½“æ¯”ä¾‹',
                description: 'èœ¡çƒ›å›¾å®ä½“å æ•´ä¸ªKçº¿èŒƒå›´çš„æœ€å°æ¯”ä¾‹ï¼ˆå°æ•°å½¢å¼ï¼‰ã€‚ç”¨äºè¯†åˆ«é”¤å­çº¿ç­‰å½¢æ€ã€‚å¸¸ç”¨å€¼ï¼š0.2-0.4ã€‚æ•°å€¼è¶Šå°ï¼Œè¯†åˆ«æ ‡å‡†è¶Šå®½æ¾ã€‚'
            },
            'min_shadow_ratio': {
                title: 'æœ€å°å½±çº¿æ¯”ä¾‹',
                description: 'å½±çº¿ç›¸å¯¹äºå®ä½“çš„æœ€å°å€æ•°ã€‚ç”¨äºè¯†åˆ«é”¤å­çº¿ï¼Œä¾‹å¦‚2.0è¡¨ç¤ºå½±çº¿è‡³å°‘æ˜¯å®ä½“çš„2å€ã€‚å¸¸ç”¨å€¼ï¼š1.5-3.0ã€‚æ•°å€¼è¶Šå¤§è¦æ±‚å½±çº¿è¶Šé•¿ã€‚'
            },
            'swing_period': {
                title: 'æ³¢æ®µå‘¨æœŸ',
                description: 'è®¡ç®—æ³¢æ®µé«˜ç‚¹å’Œä½ç‚¹çš„å‘¨æœŸã€‚ç”¨äºæ³¢æ®µäº¤æ˜“ç­–ç•¥ä¸­è¯†åˆ«æ”¯æ’‘ä½å’Œé˜»åŠ›ä½ã€‚å¸¸ç”¨å€¼ï¼š10-20ã€‚å‘¨æœŸè¶Šé•¿ï¼Œæ”¯æ’‘/é˜»åŠ›ä½è¶Šå¯é ã€‚'
            },
            'pullback_ratio': {
                title: 'å›è°ƒæ¯”ä¾‹',
                description: 'ä»·æ ¼å›è°ƒçš„ç™¾åˆ†æ¯”é˜ˆå€¼ï¼ˆå°æ•°å½¢å¼ï¼‰ã€‚ä¾‹å¦‚0.05è¡¨ç¤ºä»·æ ¼ä»é«˜ç‚¹å›è°ƒ5%æ—¶ä¹°å…¥ã€‚å¸¸ç”¨å€¼ï¼š0.03-0.08ã€‚æ•°å€¼è¶Šå¤§ä¹°å…¥æœºä¼šè¶Šå¤šä½†å¯èƒ½ä¹°å…¥è¿‡æ—©ã€‚'
            },
            'profit_target': {
                title: 'ç›ˆåˆ©ç›®æ ‡',
                description: 'æ³¢æ®µäº¤æ˜“çš„ç›ˆåˆ©ç›®æ ‡ï¼ˆå°æ•°å½¢å¼ï¼‰ã€‚ä¾‹å¦‚0.10è¡¨ç¤ºç›ˆåˆ©10%æ—¶å–å‡ºã€‚å¸¸ç”¨å€¼ï¼š0.05-0.15ã€‚æ•°å€¼è¶Šå¤§ç›®æ ‡è¶Šé«˜ä½†å¯èƒ½é”™è¿‡å–å‡ºæœºä¼šã€‚'
            },
            'stop_loss': {
                title: 'æ­¢æŸæ¯”ä¾‹',
                description: 'æ³¢æ®µäº¤æ˜“çš„æ­¢æŸæ¯”ä¾‹ï¼ˆå°æ•°å½¢å¼ï¼‰ã€‚ä¾‹å¦‚0.05è¡¨ç¤ºäºæŸ5%æ—¶æ­¢æŸã€‚å¸¸ç”¨å€¼ï¼š0.03-0.08ã€‚æ•°å€¼è¶Šå¤§èƒ½æ‰¿å—æ›´å¤šæ³¢åŠ¨ä½†äºæŸå¯èƒ½æ›´å¤§ã€‚'
            },
            'adx_period': {
                title: 'ADXå‘¨æœŸ',
                description: 'ADXæŒ‡æ ‡çš„è®¡ç®—å‘¨æœŸã€‚ADXç”¨äºç¡®è®¤è¶‹åŠ¿å¼ºåº¦ã€‚å¸¸ç”¨å€¼ï¼š14ã€‚å‘¨æœŸè¶Šé•¿ADXè¶Šå¹³æ»‘ä½†ååº”è¶Šæ…¢ã€‚'
            },
            'adx_threshold': {
                title: 'ADXé˜ˆå€¼',
                description: 'ADXæŒ‡æ ‡çš„æœ€ä½é˜ˆå€¼ï¼Œè¶…è¿‡æ­¤å€¼è®¤ä¸ºè¶‹åŠ¿å¼ºåŠ²ã€‚å¸¸ç”¨å€¼ï¼š20-30ã€‚æ•°å€¼è¶Šå¤§è¦æ±‚è¶‹åŠ¿è¶Šå¼ºï¼Œä¿¡å·è¶Šå¯é ä½†æœºä¼šè¶Šå°‘ã€‚'
            },
            'trailing_stop': {
                title: 'è¿½è¸ªæ­¢æŸ',
                description: 'è¶‹åŠ¿è·Ÿè¸ªç­–ç•¥çš„è¿½è¸ªæ­¢æŸæ¯”ä¾‹ï¼ˆå°æ•°å½¢å¼ï¼‰ã€‚ä¾‹å¦‚0.03è¡¨ç¤ºä»æœ€é«˜ç‚¹å›æ’¤3%æ—¶å–å‡ºã€‚å¸¸ç”¨å€¼ï¼š0.02-0.05ã€‚æ•°å€¼è¶Šå¤§èƒ½æ‰¿å—æ›´å¤šæ³¢åŠ¨ä½†å¯èƒ½å›åæ›´å¤šåˆ©æ¶¦ã€‚'
            },
        };
        
        // ç­–ç•¥é€‰æ‹©å˜åŒ–æ—¶ï¼Œæ˜¾ç¤º/éšè—å‚æ•°å’Œè¯´æ˜
        function initStrategyParams() {
            const strategySelect = document.getElementById('strategy');
            if (!strategySelect) {
                console.warn('ç­–ç•¥é€‰æ‹©æ¡†æœªæ‰¾åˆ°ï¼Œå°†åœ¨100msåé‡è¯•');
                setTimeout(initStrategyParams, 100);
                return;
            }
            
            strategySelect.addEventListener('change', function() {
                const selectedStrategy = this.value;
                const paramsContainer = document.getElementById('strategyParams');
                const descriptionDiv = document.getElementById('strategyDescription');
                const selectedOption = this.options[this.selectedIndex];
                
                if (!paramsContainer || !descriptionDiv) {
                    console.error('ç­–ç•¥å‚æ•°å®¹å™¨æœªæ‰¾åˆ°');
                    return;
                }
                
                if (selectedStrategy && strategies[selectedStrategy]) {
                    const strategy = strategies[selectedStrategy];
                    
                    // æ˜¾ç¤ºç­–ç•¥è¯´æ˜
                    descriptionDiv.textContent = strategy.description;
                    descriptionDiv.style.display = 'block';
                    
                    // ç”Ÿæˆå‚æ•°è¾“å…¥æ¡†
                    let html = '<h3 style="color: #4CAF50; margin-bottom: 15px;">ç­–ç•¥å‚æ•°é…ç½®</h3>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">';
                    
                    for (const [key, value] of Object.entries(strategy.params)) {
                        const inputType = typeof value === 'number' ? 'number' : 'text';
                        const step = typeof value === 'number' && value % 1 !== 0 ? '0.01' : '1';
                        const paramInfo = paramDescriptions[key];
                        const paramName = key.replace(/_/g, ' ');
                        
                        // å¦‚æœå‚æ•°è¯´æ˜æ˜¯å¯¹è±¡ï¼Œä½¿ç”¨è¯¦ç»†è¯´æ˜ï¼›å¦åˆ™ä½¿ç”¨ç®€å•å­—ç¬¦ä¸²
                        let title, description;
                        if (paramInfo && typeof paramInfo === 'object' && paramInfo.title) {
                            title = paramInfo.title;
                            description = paramInfo.description || '';
                        } else {
                            title = paramInfo && typeof paramInfo === 'string' ? paramInfo : `${key}å‚æ•°`;
                            description = '';
                        }
                        
                        html += `
                            <div class="param-group" style="display: flex; flex-direction: column; background-color: #1e1e1e; padding: 15px; border-radius: 5px; border: 1px solid #333;">
                                <label style="margin-bottom: 8px; color: #4CAF50; font-weight: bold; font-size: 1em;">${paramName}</label>
                                <input type="${inputType}" 
                                       id="param_${key}"
                                       name="param_${key}" 
                                       value="${value}" 
                                       step="${step}"
                                       style="width: 100%; padding: 8px; margin-bottom: 8px; background-color: #2d2d2d; border: 1px solid #555; color: #fff; border-radius: 4px;">
                                <div style="color: #ccc; font-size: 0.9em; font-weight: 500; margin-bottom: 5px;">${title}</div>
                                ${description ? `<div style="color: #999; font-size: 0.85em; line-height: 1.4; margin-bottom: 5px;">${description}</div>` : ''}
                            </div>
                        `;
                    }
                    html += '</div>';
                    
                    paramsContainer.innerHTML = html;
                    paramsContainer.classList.add('active');
                } else {
                    descriptionDiv.style.display = 'none';
                    paramsContainer.classList.remove('active');
                }
            });
            
            // å¦‚æœå·²ç»æœ‰é€‰ä¸­çš„ç­–ç•¥ï¼Œè§¦å‘ä¸€æ¬¡changeäº‹ä»¶æ¥æ˜¾ç¤ºå‚æ•°
            if (strategySelect.value) {
                strategySelect.dispatchEvent(new Event('change'));
            }
        }
        
        // åœ¨DOMåŠ è½½å®Œæˆååˆå§‹åŒ–ç­–ç•¥å‚æ•°
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initStrategyParams);
        } else {
            initStrategyParams();
        }

        // è®¾ç½®æœ€å¤§æ—¥æœŸä¸ºä»Šå¤©ï¼ˆé˜²æ­¢é€‰æ‹©æœªæ¥æ—¥æœŸï¼‰
        const today = new Date();
        // å½“é€‰æ‹©æ ‡çš„æ—¶ï¼Œè‡ªåŠ¨è°ƒæ•´æ—¥æœŸèŒƒå›´åˆ°è¯¥æ ‡çš„çš„æ•°æ®èŒƒå›´å†…
        const symbolSelect = document.getElementById('symbol');
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        
        // è®¾ç½®æ—¥æœŸè¾“å…¥æ¡†çš„æœ€å¤§å€¼ä¸ºä»Šå¤©
        if (endDateInput) {
            endDateInput.setAttribute('max', today.toISOString().split('T')[0]);
        }
        if (startDateInput) {
            startDateInput.setAttribute('max', today.toISOString().split('T')[0]);
        }
        
        // å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥è®¾ç½®æ—¥æœŸèŒƒå›´ï¼Œå¯ä»¥åœ¨changeäº‹ä»¶å’Œåˆå§‹åŒ–æ—¶è°ƒç”¨
        function setDateRangeForSymbol() {
            console.log('setDateRangeForSymbol è¢«è°ƒç”¨');
            
            // é‡æ–°è·å–å…ƒç´ ï¼Œç¡®ä¿å®ƒä»¬å­˜åœ¨
            const symbolSelect = document.getElementById('symbol');
            const startDateInput = document.getElementById('start_date');
            const endDateInput = document.getElementById('end_date');
            
            if (!symbolSelect) {
                console.error('symbolSelect æœªæ‰¾åˆ°');
                return;
            }
            
            if (!startDateInput || !endDateInput) {
                console.error('æ—¥æœŸè¾“å…¥æ¡†æœªæ‰¾åˆ°', { startDateInput: !!startDateInput, endDateInput: !!endDateInput });
                return;
            }
            
            const selectedOption = symbolSelect.options[symbolSelect.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                console.log('æœªé€‰ä¸­æ ‡çš„ï¼Œè®¾ç½®é»˜è®¤æ—¥æœŸ');
                // å¦‚æœæ²¡æœ‰é€‰ä¸­æ ‡çš„ï¼Œè®¾ç½®é»˜è®¤æ—¥æœŸ
                const defaultEndDate = new Date(2023, 11, 31); // 2023-12-31
                const defaultStartDate = new Date(2022, 0, 1); // 2022-01-01
                if (!endDateInput.value) {
                    endDateInput.value = defaultEndDate.toISOString().split('T')[0];
                }
                if (!startDateInput.value) {
                    startDateInput.value = defaultStartDate.toISOString().split('T')[0];
                }
                return;
            }
            
            const minDate = selectedOption.getAttribute('data-min-date');
            const maxDate = selectedOption.getAttribute('data-max-date');
            const count = selectedOption.getAttribute('data-count');
            const dataRangeDiv = document.getElementById('symbolDataRange');
            
            console.log('========================================');
            console.log('ğŸ“‹ ä»é€‰é¡¹è·å–çš„åŸå§‹æ•°æ®:');
            console.log('  æ ‡çš„ä»£ç :', selectedOption.value);
            console.log('  æœ€å°æ—¥æœŸ(data-min-date):', minDate);
            console.log('  æœ€å¤§æ—¥æœŸ(data-max-date):', maxDate);
            console.log('  æ•°æ®æ¡æ•°(data-count):', count);
            console.log('  å½“å‰å¼€å§‹æ—¥æœŸè¾“å…¥æ¡†å€¼:', startDateInput ? startDateInput.value : 'N/A');
            console.log('  å½“å‰ç»“æŸæ—¥æœŸè¾“å…¥æ¡†å€¼:', endDateInput ? endDateInput.value : 'N/A');
            console.log('========================================');
            
            if (minDate && maxDate) {
                // æ˜¾ç¤ºæ•°æ®èŒƒå›´æç¤º
                if (dataRangeDiv) {
                    dataRangeDiv.style.display = 'block';
                    dataRangeDiv.innerHTML = `ğŸ“Š æ•°æ®èŒƒå›´: ${minDate} è‡³ ${maxDate} (å…±${count}æ¡æ•°æ®)`;
                }
                
                // ç¡®ä¿ä¸è¶…è¿‡ä»Šå¤©ï¼ˆè¿‡æ»¤æœªæ¥æ—¥æœŸï¼‰
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const maxDateObj = new Date(maxDate);
                maxDateObj.setHours(0, 0, 0, 0);
                const minDateObj = new Date(minDate);
                minDateObj.setHours(0, 0, 0, 0);
                
                console.log('æ—¥æœŸè¿‡æ»¤æ£€æŸ¥:', {
                    today: today.toISOString().split('T')[0],
                    maxDateObj: maxDateObj.toISOString().split('T')[0],
                    minDateObj: minDateObj.toISOString().split('T')[0],
                    isMaxDateFuture: maxDateObj > today,
                    todayTime: today.getTime(),
                    maxDateObjTime: maxDateObj.getTime()
                });
                
                // å¦‚æœæœ€å¤§æ—¥æœŸæ˜¯æœªæ¥æ—¥æœŸï¼Œä½¿ç”¨ä»Šå¤©
                // æ³¨æ„ï¼šä½¿ç”¨getTime()è¿›è¡Œç²¾ç¡®æ¯”è¾ƒï¼Œé¿å…æ—¶åŒºé—®é¢˜
                let effectiveMaxDate = maxDateObj.getTime() > today.getTime() ? today : maxDateObj;
                
                // å†æ¬¡éªŒè¯ï¼šç¡®ä¿ç»“æŸæ—¥æœŸä¸è¶…è¿‡ä»Šå¤©ï¼ˆåŒé‡ä¿é™©ï¼‰
                if (effectiveMaxDate.getTime() > today.getTime()) {
                    console.warn('âš ï¸ è­¦å‘Š: æœ‰æ•ˆæœ€å¤§æ—¥æœŸä»ç„¶å¤§äºä»Šå¤©ï¼Œå¼ºåˆ¶ä½¿ç”¨ä»Šå¤©');
                    effectiveMaxDate = today;
                }
                
                console.log('æœ‰æ•ˆæœ€å¤§æ—¥æœŸ:', effectiveMaxDate.toISOString().split('T')[0]);
                
                // è®¡ç®—åˆé€‚çš„æ—¥æœŸèŒƒå›´ï¼ˆä½¿ç”¨æ•°æ®çš„80%èŒƒå›´ï¼Œç•™ä¸€äº›ä½™é‡ï¼‰
                const totalDays = (effectiveMaxDate.getTime() - minDateObj.getTime()) / (1000 * 60 * 60 * 24);
                
                console.log('æ—¥æœŸèŒƒå›´è®¡ç®—:', {
                    totalDays: totalDays,
                    totalDaysRounded: Math.round(totalDays),
                    use80Percent: totalDays > 90
                });
                
                let finalStartDate, finalEndDate;
                
                // æ—¥æœŸèŒƒå›´é€‰æ‹©é€»è¾‘è¯´æ˜:
                // 1. å¦‚æœæ•°æ®èŒƒå›´è¾ƒå°ï¼ˆ<=90å¤©ï¼‰ï¼Œä½¿ç”¨å…¨éƒ¨èŒƒå›´
                // 2. å¦‚æœæ•°æ®èŒƒå›´è¾ƒå¤§ï¼ˆ>90å¤©ï¼‰ï¼Œä½¿ç”¨å…¨éƒ¨èŒƒå›´ï¼ˆä¸å†é™åˆ¶ä¸º80%ï¼‰
                // åŸå› ï¼šç”¨æˆ·å¸Œæœ›ä½¿ç”¨æ‰€æœ‰å¯ç”¨æ•°æ®è¿›è¡Œå›æµ‹ï¼Œè€Œä¸æ˜¯åªä½¿ç”¨éƒ¨åˆ†æ•°æ®
                if (totalDays <= 90) {
                    // å¦‚æœæ•°æ®èŒƒå›´è¾ƒå°ï¼Œä½¿ç”¨å…¨éƒ¨èŒƒå›´
                    finalStartDate = minDateObj;
                    finalEndDate = effectiveMaxDate;
                    console.log('ä½¿ç”¨å…¨éƒ¨èŒƒå›´ï¼ˆæ•°æ®èŒƒå›´è¾ƒå°ï¼Œ<=90å¤©ï¼‰');
                } else {
                    // å¦‚æœæ•°æ®èŒƒå›´è¾ƒå¤§ï¼Œä¹Ÿä½¿ç”¨å…¨éƒ¨èŒƒå›´ï¼ˆä¸å†é™åˆ¶ä¸º80%ï¼‰
                    finalStartDate = minDateObj;
                    finalEndDate = effectiveMaxDate;
                    console.log('ä½¿ç”¨å…¨éƒ¨èŒƒå›´ï¼ˆæ•°æ®èŒƒå›´è¾ƒå¤§ï¼Œ>90å¤©ï¼Œä½¿ç”¨å…¨éƒ¨æ•°æ®ï¼‰');
                    console.log('æ—¥æœŸèŒƒå›´:', {
                        totalDays: totalDays,
                        startDate: finalStartDate.toISOString().split('T')[0],
                        endDate: finalEndDate.toISOString().split('T')[0]
                    });
                }
                
                console.log('æœ€ç»ˆæ—¥æœŸå¯¹è±¡:', {
                    finalStartDate: finalStartDate.toISOString().split('T')[0],
                    finalEndDate: finalEndDate.toISOString().split('T')[0]
                });
                
                // è®¾ç½®æ—¥æœŸå€¼ - ä½¿ç”¨YYYY-MM-DDæ ¼å¼
                const startDateStr = finalStartDate.getFullYear() + '-' + 
                    String(finalStartDate.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(finalStartDate.getDate()).padStart(2, '0');
                const endDateStr = finalEndDate.getFullYear() + '-' + 
                    String(finalEndDate.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(finalEndDate.getDate()).padStart(2, '0');
                
                console.log('========================================');
                console.log('ğŸ“… è®¡ç®—åçš„æ—¥æœŸå€¼:');
                console.log('  å¼€å§‹æ—¥æœŸå¯¹è±¡:', finalStartDate);
                console.log('  ç»“æŸæ—¥æœŸå¯¹è±¡:', finalEndDate);
                console.log('  å¼€å§‹æ—¥æœŸå­—ç¬¦ä¸²:', startDateStr);
                console.log('  ç»“æŸæ—¥æœŸå­—ç¬¦ä¸²:', endDateStr);
                console.log('========================================');
                console.log('æ—¥æœŸè¾“å…¥æ¡†çŠ¶æ€:', {
                    startDateInput: {
                        exists: !!startDateInput,
                        currentValue: startDateInput ? startDateInput.value : 'N/A',
                        type: startDateInput ? startDateInput.type : 'N/A',
                        id: startDateInput ? startDateInput.id : 'N/A'
                    },
                    endDateInput: {
                        exists: !!endDateInput,
                        currentValue: endDateInput ? endDateInput.value : 'N/A',
                        type: endDateInput ? endDateInput.type : 'N/A',
                        id: endDateInput ? endDateInput.id : 'N/A'
                    }
                });
                
                // å¼ºåˆ¶è®¾ç½®æ—¥æœŸå€¼ - ä½¿ç”¨å¤šç§æ–¹å¼ç¡®ä¿è®¾ç½®æˆåŠŸ
                console.log('========================================');
                console.log('ğŸ”§ å¼€å§‹è®¾ç½®æ—¥æœŸåˆ°è¾“å…¥æ¡†...');
                
                if (startDateInput) {
                    console.log('  è®¾ç½®å‰ - å¼€å§‹æ—¥æœŸè¾“å…¥æ¡†:');
                    console.log('    valueå±æ€§:', startDateInput.value);
                    console.log('    getAttribute("value"):', startDateInput.getAttribute('value'));
                    console.log('    defaultValue:', startDateInput.defaultValue);
                    console.log('    type:', startDateInput.type);
                    console.log('    id:', startDateInput.id);
                    
                    // æ–¹æ³•1: ç›´æ¥è®¾ç½®valueå±æ€§
                    startDateInput.value = startDateStr;
                    console.log('  âœ“ æ–¹æ³•1: value = "' + startDateStr + '" â†’ å½“å‰value:', startDateInput.value);
                    
                    // æ–¹æ³•2: è®¾ç½®valueå±æ€§
                    startDateInput.setAttribute('value', startDateStr);
                    console.log('  âœ“ æ–¹æ³•2: setAttribute("value") â†’ å½“å‰value:', startDateInput.value);
                    
                    // æ–¹æ³•3: è®¾ç½®defaultValue
                    startDateInput.defaultValue = startDateStr;
                    console.log('  âœ“ æ–¹æ³•3: defaultValue â†’ å½“å‰value:', startDateInput.value);
                    
                    // æ–¹æ³•4: ä½¿ç”¨setProperty (æŸäº›æµè§ˆå™¨éœ€è¦)
                    try {
                        startDateInput.style.setProperty('--value', startDateStr);
                    } catch(e) {}
                    
                    // è§¦å‘äº‹ä»¶
                    startDateInput.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
                    startDateInput.dispatchEvent(new Event('change', { bubbles: true, cancelable: true }));
                    
                    // å¼ºåˆ¶åˆ·æ–°æ˜¾ç¤ºï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦ï¼‰
                    const temp = startDateInput.style.display;
                    startDateInput.style.display = 'none';
                    startDateInput.offsetHeight; // è§¦å‘é‡æ’
                    startDateInput.style.display = temp;
                    
                    console.log('  è®¾ç½®å - å¼€å§‹æ—¥æœŸè¾“å…¥æ¡†:');
                    console.log('    valueå±æ€§:', startDateInput.value);
                    console.log('    getAttribute("value"):', startDateInput.getAttribute('value'));
                    console.log('    defaultValue:', startDateInput.defaultValue);
                } else {
                    console.error('  âŒ startDateInput ä¸å­˜åœ¨!');
                }
                
                if (endDateInput) {
                    console.log('  è®¾ç½®å‰ - ç»“æŸæ—¥æœŸè¾“å…¥æ¡†:');
                    console.log('    valueå±æ€§:', endDateInput.value);
                    console.log('    getAttribute("value"):', endDateInput.getAttribute('value'));
                    console.log('    defaultValue:', endDateInput.defaultValue);
                    console.log('    type:', endDateInput.type);
                    console.log('    id:', endDateInput.id);
                    
                    // æ–¹æ³•1: ç›´æ¥è®¾ç½®valueå±æ€§
                    endDateInput.value = endDateStr;
                    console.log('  âœ“ æ–¹æ³•1: value = "' + endDateStr + '" â†’ å½“å‰value:', endDateInput.value);
                    
                    // æ–¹æ³•2: è®¾ç½®valueå±æ€§
                    endDateInput.setAttribute('value', endDateStr);
                    console.log('  âœ“ æ–¹æ³•2: setAttribute("value") â†’ å½“å‰value:', endDateInput.value);
                    
                    // æ–¹æ³•3: è®¾ç½®defaultValue
                    endDateInput.defaultValue = endDateStr;
                    console.log('  âœ“ æ–¹æ³•3: defaultValue â†’ å½“å‰value:', endDateInput.value);
                    
                    // æ–¹æ³•4: ä½¿ç”¨setProperty (æŸäº›æµè§ˆå™¨éœ€è¦)
                    try {
                        endDateInput.style.setProperty('--value', endDateStr);
                    } catch(e) {}
                    
                    // è§¦å‘äº‹ä»¶
                    endDateInput.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
                    endDateInput.dispatchEvent(new Event('change', { bubbles: true, cancelable: true }));
                    
                    // å¼ºåˆ¶åˆ·æ–°æ˜¾ç¤ºï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦ï¼‰
                    const temp2 = endDateInput.style.display;
                    endDateInput.style.display = 'none';
                    endDateInput.offsetHeight; // è§¦å‘é‡æ’
                    endDateInput.style.display = temp2;
                    
                    console.log('  è®¾ç½®å - ç»“æŸæ—¥æœŸè¾“å…¥æ¡†:');
                    console.log('    valueå±æ€§:', endDateInput.value);
                    console.log('    getAttribute("value"):', endDateInput.getAttribute('value'));
                    console.log('    defaultValue:', endDateInput.defaultValue);
                } else {
                    console.error('  âŒ endDateInput ä¸å­˜åœ¨!');
                }
                console.log('========================================');
                
                // å†æ¬¡éªŒè¯è®¾ç½®æ˜¯å¦æˆåŠŸ
                setTimeout(function() {
                    const startVal = startDateInput ? startDateInput.value : 'N/A';
                    const endVal = endDateInput ? endDateInput.value : 'N/A';
                    
                    console.log('========================================');
                    console.log('ğŸ” éªŒè¯æ—¥æœŸè®¾ç½®ç»“æœ (200mså):');
                    console.log('  å¼€å§‹æ—¥æœŸ:');
                    console.log('    æœŸæœ›å€¼:', startDateStr);
                    console.log('    å®é™…å€¼:', startVal);
                    console.log('    æ˜¯å¦åŒ¹é…:', startVal === startDateStr ? 'âœ… æ˜¯' : 'âŒ å¦');
                    console.log('    æ˜¯å¦ä¸ºç©º:', startVal === '' ? 'âš ï¸ æ˜¯' : 'å¦');
                    console.log('  ç»“æŸæ—¥æœŸ:');
                    console.log('    æœŸæœ›å€¼:', endDateStr);
                    console.log('    å®é™…å€¼:', endVal);
                    console.log('    æ˜¯å¦åŒ¹é…:', endVal === endDateStr ? 'âœ… æ˜¯' : 'âŒ å¦');
                    console.log('    æ˜¯å¦ä¸ºç©º:', endVal === '' ? 'âš ï¸ æ˜¯' : 'å¦');
                    
                    // å¦‚æœè®¾ç½®å¤±è´¥ï¼Œå°è¯•å†æ¬¡è®¾ç½®
                    if (startDateInput && startVal !== startDateStr) {
                        console.warn('  âš ï¸ å¼€å§‹æ—¥æœŸè®¾ç½®å¤±è´¥ï¼Œå°è¯•å†æ¬¡è®¾ç½®...');
                        startDateInput.value = startDateStr;
                        startDateInput.setAttribute('value', startDateStr);
                        // å¼ºåˆ¶åˆ·æ–°
                        const temp = startDateInput.style.display;
                        startDateInput.style.display = 'none';
                        startDateInput.offsetHeight;
                        startDateInput.style.display = temp;
                        console.log('    é‡è¯•åvalue:', startDateInput.value);
                    }
                    if (endDateInput && endVal !== endDateStr) {
                        console.warn('  âš ï¸ ç»“æŸæ—¥æœŸè®¾ç½®å¤±è´¥ï¼Œå°è¯•å†æ¬¡è®¾ç½®...');
                        endDateInput.value = endDateStr;
                        endDateInput.setAttribute('value', endDateStr);
                        // å¼ºåˆ¶åˆ·æ–°
                        const temp2 = endDateInput.style.display;
                        endDateInput.style.display = 'none';
                        endDateInput.offsetHeight;
                        endDateInput.style.display = temp2;
                        console.log('    é‡è¯•åvalue:', endDateInput.value);
                    }
                    
                    // æœ€ç»ˆéªŒè¯ï¼šå¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œç›´æ¥æ“ä½œDOM
                    if (startDateInput && startDateInput.value !== startDateStr) {
                        console.error('  âŒ å¼€å§‹æ—¥æœŸè®¾ç½®ä»ç„¶å¤±è´¥ï¼Œå°è¯•ç›´æ¥æ“ä½œDOM...');
                        startDateInput.setAttribute('value', startDateStr);
                        startDateInput.value = startDateStr;
                        // å°è¯•ä½¿ç”¨åŸç”Ÿæ–¹æ³•
                        if (startDateInput.setValue) {
                            startDateInput.setValue(startDateStr);
                        }
                    }
                    if (endDateInput && endDateInput.value !== endDateStr) {
                        console.error('  âŒ ç»“æŸæ—¥æœŸè®¾ç½®ä»ç„¶å¤±è´¥ï¼Œå°è¯•ç›´æ¥æ“ä½œDOM...');
                        endDateInput.setAttribute('value', endDateStr);
                        endDateInput.value = endDateStr;
                        // å°è¯•ä½¿ç”¨åŸç”Ÿæ–¹æ³•
                        if (endDateInput.setValue) {
                            endDateInput.setValue(endDateStr);
                        }
                    }
                    console.log('========================================');
                }, 200);
                
                // è®¾ç½®æ—¥æœŸè¾“å…¥æ¡†çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ï¼ˆé™åˆ¶åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼‰
                startDateInput.setAttribute('min', minDate);
                startDateInput.setAttribute('max', effectiveMaxDate.toISOString().split('T')[0]);
                endDateInput.setAttribute('min', minDate);
                endDateInput.setAttribute('max', effectiveMaxDate.toISOString().split('T')[0]);
            } else {
                console.warn('æœªæ‰¾åˆ°æ—¥æœŸèŒƒå›´æ•°æ®', { minDate, maxDate });
                if (dataRangeDiv) {
                    dataRangeDiv.style.display = 'none';
                }
            }
        }
        
        // ç¡®ä¿åœ¨DOMåŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
        function initDateRangeHandler() {
            const symbolSelect = document.getElementById('symbol');
            const startDateInput = document.getElementById('start_date');
            const endDateInput = document.getElementById('end_date');
            
            if (!symbolSelect) {
                console.warn('symbolSelect æœªæ‰¾åˆ°ï¼Œå°†åœ¨100msåé‡è¯•');
                setTimeout(initDateRangeHandler, 100);
                return;
            }
            
            if (!startDateInput || !endDateInput) {
                console.warn('æ—¥æœŸè¾“å…¥æ¡†æœªæ‰¾åˆ°ï¼Œå°†åœ¨100msåé‡è¯•');
                setTimeout(initDateRangeHandler, 100);
                return;
            }
            
            console.log('åˆå§‹åŒ–æ—¥æœŸèŒƒå›´å¤„ç†å™¨');
            
            // ç›‘å¬æ ‡çš„é€‰æ‹©å˜åŒ–
            symbolSelect.addEventListener('change', function() {
                console.log('æ ‡çš„é€‰æ‹©å˜åŒ–:', this.value);
                setDateRangeForSymbol();
            });
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„æ ‡çš„å¹¶è‡ªåŠ¨è®¾ç½®æ—¥æœŸ
            if (symbolSelect.selectedIndex > 0 && symbolSelect.value) {
                console.log('é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è®¾ç½®æ—¥æœŸï¼Œé€‰ä¸­çš„æ ‡çš„:', symbolSelect.value);
                // å»¶è¿Ÿä¸€ç‚¹æ‰§è¡Œï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
                setTimeout(function() {
                    setDateRangeForSymbol();
                }, 50);
            } else if (!startDateInput.value && !endDateInput.value) {
                // å¦‚æœæ²¡æœ‰é€‰ä¸­æ ‡çš„ä¸”æ—¥æœŸä¸ºç©ºï¼Œè®¾ç½®é»˜è®¤æ—¥æœŸ
                const defaultEndDate = new Date(2023, 11, 31); // 2023-12-31
                const defaultStartDate = new Date(2022, 0, 1); // 2022-01-01
                endDateInput.value = defaultEndDate.toISOString().split('T')[0];
                startDateInput.value = defaultStartDate.toISOString().split('T')[0];
                console.log('è®¾ç½®é»˜è®¤æ—¥æœŸ:', startDateInput.value, 'åˆ°', endDateInput.value);
            }
        }
        
        // åœ¨DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDateRangeHandler);
        } else {
            // DOMå·²ç»åŠ è½½å®Œæˆ
            initDateRangeHandler();
        }
        
        // æ·»åŠ æ—¥æœŸéªŒè¯ï¼ˆåœ¨DOMåŠ è½½å®Œæˆåï¼‰
        function initDateValidation() {
            const startDateInput = document.getElementById('start_date');
            const endDateInput = document.getElementById('end_date');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (startDateInput) {
                startDateInput.addEventListener('change', function() {
                    const startDate = new Date(this.value);
                    const endDateInput = document.getElementById('end_date');
                    const endDate = new Date(endDateInput.value);
                    
                    if (startDate > today) {
                        alert('âš ï¸ å¼€å§‹æ—¥æœŸä¸èƒ½æ˜¯æœªæ¥æ—¥æœŸï¼å·²è‡ªåŠ¨è°ƒæ•´ä¸ºä»Šå¤©');
                        this.value = today.toISOString().split('T')[0];
                    }
                    
                    if (startDate > endDate) {
                        alert('âš ï¸ å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸï¼å·²è‡ªåŠ¨è°ƒæ•´');
                        endDateInput.value = this.value;
                    }
                });
            }
            
            if (endDateInput) {
                endDateInput.addEventListener('change', function() {
                    const endDate = new Date(this.value);
                    const startDateInput = document.getElementById('start_date');
                    const startDate = new Date(startDateInput.value);
                    
                    if (endDate > today) {
                        alert('âš ï¸ ç»“æŸæ—¥æœŸä¸èƒ½æ˜¯æœªæ¥æ—¥æœŸï¼å·²è‡ªåŠ¨è°ƒæ•´ä¸ºä»Šå¤©');
                        this.value = today.toISOString().split('T')[0];
                    }
                    
                    if (endDate < startDate) {
                        alert('âš ï¸ ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸï¼å·²è‡ªåŠ¨è°ƒæ•´');
                        startDateInput.value = this.value;
                    }
                });
            }
        }
        
        // åœ¨DOMåŠ è½½å®Œæˆååˆå§‹åŒ–æ—¥æœŸéªŒè¯
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDateValidation);
        } else {
            initDateValidation();
        }
        
        // æ•°æ®ç²’åº¦é€‰æ‹©å˜åŒ–
        const dataTypeSelect = document.getElementById('data_type');
        if (dataTypeSelect) {
            dataTypeSelect.addEventListener('change', function() {
                const intervalGroup = document.getElementById('intervalGroup');
                const dataTypeHint = document.getElementById('dataTypeHint');
                
                if (this.value === 'minute') {
                    if (intervalGroup) {
                        intervalGroup.style.display = 'block';
                    }
                    if (dataTypeHint) {
                        dataTypeHint.textContent = 'åˆ†é’ŸKæ•°æ®é€‚ç”¨äºçŸ­æœŸç­–ç•¥å’Œæ—¥å†…äº¤æ˜“å›æµ‹ï¼Œæ•°æ®é‡å¤§';
                    }
                } else {
                    if (intervalGroup) {
                        intervalGroup.style.display = 'none';
                    }
                    if (dataTypeHint) {
                        dataTypeHint.textContent = 'æ—¥Kæ•°æ®é€‚ç”¨äºé•¿æœŸç­–ç•¥å›æµ‹ï¼Œæ•°æ®æ›´ç¨³å®š';
                    }
                }
            });
        }

        // å›æµ‹å‡½æ•°
        function runBacktest() {
            console.log('runBacktest() called');
            
            const backtestForm = document.getElementById('backtestForm');
            if (!backtestForm) {
                console.error('Form not found!');
                return;
            }
            
            const btnRun = document.getElementById('btnRun');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const resultContainer = document.getElementById('resultContainer');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btnRun.disabled = true;
            loading.classList.add('active');
            loading.style.display = 'block';
            error.classList.remove('active');
            error.style.display = 'none';
            resultContainer.classList.remove('active');
            resultContainer.style.display = 'none';
            
            // æ¸…ç©ºä¹‹å‰çš„å›¾è¡¨
            const chartElement = document.getElementById('resultChart');
            if (chartElement) {
                // å…ˆé”€æ¯æ—§çš„å›¾è¡¨å®ä¾‹ï¼Œé¿å…å†…å­˜æ³„æ¼
                if (typeof equityChart !== 'undefined' && equityChart !== null) {
                    try {
                        equityChart.dispose();
                    } catch (e) {
                        console.warn('Error disposing old chart:', e);
                    }
                    equityChart = null;
                }
                // æ¸…ç©ºå›¾è¡¨å®¹å™¨
                try {
                    chartElement.innerHTML = '';
                } catch (e) {
                    console.warn('Error clearing chart element:', e);
                }
            }
            
            console.log('Starting backtest...');  // è°ƒè¯•æ—¥å¿—
            
            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = new FormData(backtestForm);
            // å°†æ‰‹ç»­è´¹ä»ç™¾åˆ†æ¯”è½¬æ¢ä¸ºå°æ•°
            const commissionValue = formData.get('commission');
            console.log('Commission value:', commissionValue);
            formData.set('commission', parseFloat(commissionValue) / 100);
            
            // è·å–CSRF token
            const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfTokenElement) {
                console.error('CSRF token not found!');
                error.textContent = 'é”™è¯¯: CSRF tokenæœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                error.classList.add('active');
                loading.classList.remove('active');
                btnRun.disabled = false;
                return;
            }
            const csrfToken = csrfTokenElement.value;
            console.log('CSRF token:', csrfToken ? 'Found' : 'Not found');
            console.log('Form data:', Array.from(formData.entries()));
            
            // å‘é€è¯·æ±‚
            const apiUrl = '{% url "backtest_api" %}';
            console.log('Sending POST request to:', apiUrl);
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => {
                // æ£€æŸ¥å“åº”ç±»å‹
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    // å¦‚æœä¸æ˜¯JSONï¼Œå°è¯•è¯»å–æ–‡æœ¬
                    return response.text().then(text => {
                        console.error('Server response:', text);
                        throw new Error('æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”ï¼Œå¯èƒ½æ˜¯é”™è¯¯é¡µé¢');
                    });
                }
            })
            .then(data => {
                console.log('Backtest response received:', data);
                loading.classList.remove('active');
                loading.style.display = 'none';
                btnRun.disabled = false;
                
                if (data.error) {
                    console.error('Backtest error:', data.error);
                    error.textContent = 'é”™è¯¯: ' + data.error;
                    error.style.display = 'block';
                    error.classList.add('active');
                    return;
                }
                
                // æ˜¾ç¤ºç»“æœ
                console.log('Displaying results, equity_curve length:', data.equity_curve ? data.equity_curve.length : 0);
                console.log('Result data:', {
                    total_return: data.total_return,
                    final_value: data.final_value,
                    equity_curve_points: data.equity_curve ? data.equity_curve.length : 0
                });
                
                // ç¡®ä¿ç»“æœå®¹å™¨å¯è§
                resultContainer.style.display = 'block';
                resultContainer.classList.add('active');
                
                // æ˜¾ç¤ºç»“æœ
                displayResults(data);
                
                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                setTimeout(() => {
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            })
            .catch(err => {
                loading.classList.remove('active');
                btnRun.disabled = false;
                error.textContent = 'é”™è¯¯: ' + (err.message || 'å›æµ‹æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥å‚æ•°å’Œæ•°æ®');
                error.classList.add('active');
                console.error('Backtest error:', err);
            });
        }
        
        // å‚æ•°ä¼˜åŒ–å‡½æ•°
        function runOptimize() {
            console.log('runOptimize() called');
            
            const backtestForm = document.getElementById('backtestForm');
            if (!backtestForm) {
                console.error('Form not found!');
                return;
            }
            
            const formData = new FormData(backtestForm);
            const btnOptimize = document.getElementById('btnOptimize');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const resultContainer = document.getElementById('resultContainer');
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            const symbol = formData.get('symbol');
            const strategy = formData.get('strategy');
            const startDate = formData.get('start_date');
            const endDate = formData.get('end_date');
            
            if (!symbol || !strategy || !startDate || !endDate) {
                error.textContent = 'è¯·å…ˆé€‰æ‹©æ ‡çš„,ç­–ç•¥å’Œæ—¥æœŸèŒƒå›´';
                error.classList.add('active');
                return;
            }
            
            // éªŒè¯æ—¥æœŸèŒƒå›´
            const start = new Date(startDate);
            const end = new Date(endDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (start > today || end > today) {
                error.textContent = 'é”™è¯¯: ä¸èƒ½é€‰æ‹©æœªæ¥æ—¥æœŸ!è¯·ä½¿ç”¨å†å²æ—¥æœŸèŒƒå›´(ä¾‹å¦‚: 2022-01-01 åˆ° 2023-12-31)';
                error.classList.add('active');
                loading.classList.remove('active');
                btnOptimize.disabled = false;
                return;
            }
            
            if (start > end) {
                error.textContent = 'é”™è¯¯: å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ';
                error.classList.add('active');
                loading.classList.remove('active');
                btnOptimize.disabled = false;
                return;
            }
            
            // æ£€æŸ¥æ—¥æœŸèŒƒå›´æ˜¯å¦å¤ªçŸ­(è‡³å°‘éœ€è¦1ä¸ªæœˆçš„æ•°æ®)
            const daysDiff = (end - start) / (1000 * 60 * 60 * 24);
            if (daysDiff < 30) {
                const daysRounded = Math.round(daysDiff);
                const confirmMsg = 'âš ï¸ è­¦å‘Š: æ—¥æœŸèŒƒå›´åªæœ‰ ' + daysRounded + ' å¤©,å¯èƒ½æ•°æ®ä¸è¶³å¯¼è‡´ç­–ç•¥æ— æ³•äº§ç”Ÿäº¤æ˜“ä¿¡å·.\n\nå»ºè®®ä½¿ç”¨è‡³å°‘3-6ä¸ªæœˆçš„å†å²æ•°æ®.\n\næ˜¯å¦ç»§ç»­?';
                if (!confirm(confirmMsg)) {
                    loading.classList.remove('active');
                    btnOptimize.disabled = false;
                    return;
                }
            }
            
            // ç¦ç”¨æŒ‰é’®,æ˜¾ç¤ºåŠ è½½
            btnOptimize.disabled = true;
            loading.style.display = 'block';
            loading.classList.add('active');
            loading.querySelector('p').textContent = 'æ­£åœ¨ä¼˜åŒ–å‚æ•°,è¯·ç¨å€™...(è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)';
            error.classList.remove('active');
            resultContainer.style.display = 'none';
            
            // è·å–CSRF token
            const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfTokenElement) {
                error.textContent = 'é”™è¯¯: CSRF tokenæœªæ‰¾åˆ°,è¯·åˆ·æ–°é¡µé¢é‡è¯•';
                error.classList.add('active');
                loading.classList.remove('active');
                btnOptimize.disabled = false;
                return;
            }
            const csrfToken = csrfTokenElement.value;
            
            // æ‰“å°è°ƒè¯•ä¿¡æ¯,ç¡®è®¤æ—¥æœŸèŒƒå›´
            console.log('å‚æ•°ä¼˜åŒ– - ä½¿ç”¨çš„æ—¥æœŸèŒƒå›´:');
            console.log('  å¼€å§‹æ—¥æœŸ:', startDate);
            console.log('  ç»“æŸæ—¥æœŸ:', endDate);
            console.log('  æ ‡çš„:', symbol);
            console.log('  ç­–ç•¥:', strategy);
            
            // å‘é€è¯·æ±‚
            fetch('{% url "optimize_strategy_api" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Optimize response received:', data);
                console.log('Best chart data:', data.best_chart_data);
                console.log('Top results sample:', data.top_results?.[0]);
                console.log('Best by return:', data.best_by_return);
                loading.classList.remove('active');
                loading.style.display = 'none';
                btnOptimize.disabled = false;
                
                if (data.error) {
                    console.error('Optimize error:', data.error);
                    error.textContent = 'é”™è¯¯: ' + data.error;
                    error.style.display = 'block';
                    error.classList.add('active');
                    return;
                }
                
                // æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
                displayOptimizeResults(data);
                
                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                setTimeout(() => {
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            })
            .catch(err => {
                loading.classList.remove('active');
                btnOptimize.disabled = false;
                error.textContent = 'é”™è¯¯: ' + (err.message || 'å‚æ•°ä¼˜åŒ–å¤±è´¥,è¯·æ£€æŸ¥å‚æ•°å’Œæ•°æ®');
                error.classList.add('active');
                console.error('Optimize error:', err);
            });
        }
        
        // ç»‘å®šæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼ˆåœ¨é¡µé¢åŠ è½½å®Œæˆåï¼‰
        (function() {
            function bindButtons() {
                // ç»‘å®šå›æµ‹æŒ‰é’®
                const btnRun = document.getElementById('btnRun');
                if (btnRun) {
                    btnRun.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('å›æµ‹æŒ‰é’®è¢«ç‚¹å‡»');
                        runBacktest();
                        return false;
                    });
                    console.log('å›æµ‹æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
                } else {
                    console.warn('å›æµ‹æŒ‰é’®æœªæ‰¾åˆ°');
                }
                
                // ç»‘å®šå‚æ•°ä¼˜åŒ–æŒ‰é’®
                const btnOptimize = document.getElementById('btnOptimize');
                if (btnOptimize) {
                    btnOptimize.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('å‚æ•°ä¼˜åŒ–æŒ‰é’®è¢«ç‚¹å‡»');
                        runOptimize();
                        return false;
                    });
                    console.log('å‚æ•°ä¼˜åŒ–æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
                } else {
                    console.warn('å‚æ•°ä¼˜åŒ–æŒ‰é’®æœªæ‰¾åˆ°');
                }
                
                // å¦‚æœæŒ‰é’®æœªæ‰¾åˆ°ï¼Œé‡è¯•
                if (!btnRun || !btnOptimize) {
                    setTimeout(bindButtons, 100);
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', bindButtons);
            } else {
                bindButtons();
            }
        })();
        
        function displayOptimizeResults(data) {
            const resultContainer = document.getElementById('resultContainer');
            const statsContainer = document.getElementById('resultStats');
            
            // ç¡®ä¿ç»“æœå®¹å™¨å¯è§
            resultContainer.style.display = 'block';
            resultContainer.classList.add('active');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆç»“æœ
            const hasValidResults = data.valid_results > 0;
            const allZeroTrades = data.top_results && data.top_results.every(r => (r.total_trades || 0) === 0);
            
            // æ˜¾ç¤ºä¼˜åŒ–ç»“æœç»Ÿè®¡
            let statsHtml = `
                <div class="stat-card" style="grid-column: 1 / -1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                    <div class="stat-label" style="color: #fff; font-size: 18px; font-weight: bold;">å‚æ•°ä¼˜åŒ–ç»“æœ</div>
                    <div class="stat-value" style="color: #fff; font-size: 16px;">
                        æµ‹è¯•äº† ${data.total_combinations || 0} ä¸ªå‚æ•°ç»„åˆï¼Œ${data.valid_results || 0} ä¸ªæœ‰æ•ˆç»“æœ
                    </div>
            `;
            
            // å¦‚æœæ‰€æœ‰ç»“æœéƒ½æ²¡æœ‰äº¤æ˜“ï¼Œæ˜¾ç¤ºè­¦å‘Š
            if (allZeroTrades) {
                statsHtml += `
                    <div style="margin-top: 15px; padding: 15px; background: rgba(239, 83, 80, 0.2); border: 2px solid #ef5350; border-radius: 5px;">
                        <strong style="color: #ef5350; font-size: 16px;">âš ï¸ è­¦å‘Šï¼šæ‰€æœ‰å‚æ•°ç»„åˆéƒ½æ²¡æœ‰äº§ç”Ÿäº¤æ˜“ï¼</strong>
                        <div style="color: #fff; margin-top: 10px; line-height: 1.6;">
                            <p><strong>å¯èƒ½çš„åŸå› ï¼š</strong></p>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>âŒ <strong>æ—¥æœŸèŒƒå›´é—®é¢˜</strong>ï¼šé€‰æ‹©äº†æœªæ¥æ—¥æœŸæˆ–æ²¡æœ‰æ•°æ®çš„æ—¥æœŸèŒƒå›´</li>
                                <li>âŒ <strong>æ•°æ®ä¸è¶³</strong>ï¼šæ—¥æœŸèŒƒå›´å¤ªçŸ­ï¼Œæ•°æ®ç‚¹ä¸å¤Ÿï¼ˆç­–ç•¥è‡³å°‘éœ€è¦20-40æ¡æ•°æ®ï¼‰</li>
                                <li>âŒ <strong>ç­–ç•¥æ¡ä»¶æœªè§¦å‘</strong>ï¼šåœ¨é€‰æ‹©çš„æ—¥æœŸèŒƒå›´å†…ï¼Œç­–ç•¥çš„ä¹°å…¥/å–å‡ºæ¡ä»¶æ²¡æœ‰å‘ç”Ÿ</li>
                            </ul>
                            <p style="margin-top: 10px;"><strong>ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š</strong></p>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>âœ… ä½¿ç”¨å†å²æ—¥æœŸèŒƒå›´ï¼ˆå¦‚ï¼š2022-01-01 åˆ° 2023-12-31ï¼‰</li>
                                <li>âœ… ç¡®ä¿æ—¥æœŸèŒƒå›´è‡³å°‘æœ‰3-6ä¸ªæœˆçš„æ•°æ®</li>
                                <li>âœ… æ£€æŸ¥æ ‡çš„æ˜¯å¦æœ‰è¶³å¤Ÿçš„å†å²æ•°æ®</li>
                                <li>âœ… å°è¯•æ›´é•¿çš„æ—¥æœŸèŒƒå›´æˆ–ä¸åŒçš„ç­–ç•¥</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            statsHtml += `</div>`;
            
            // å¦‚æœæ‰€æœ‰ç»“æœéƒ½æ²¡æœ‰äº¤æ˜“ï¼Œæ˜¾ç¤ºè­¦å‘Š
            if (allZeroTrades) {
                statsHtml += `
                    <div style="margin-top: 15px; padding: 15px; background: rgba(239, 83, 80, 0.2); border: 2px solid #ef5350; border-radius: 5px;">
                        <strong style="color: #ef5350; font-size: 16px;">âš ï¸ è­¦å‘Šï¼šæ‰€æœ‰å‚æ•°ç»„åˆéƒ½æ²¡æœ‰äº§ç”Ÿäº¤æ˜“ï¼</strong>
                        <div style="color: #fff; margin-top: 10px; line-height: 1.6;">
                            <p><strong>å¯èƒ½çš„åŸå› ï¼š</strong></p>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>âŒ <strong>æ—¥æœŸèŒƒå›´é—®é¢˜</strong>ï¼šé€‰æ‹©äº†æœªæ¥æ—¥æœŸæˆ–æ²¡æœ‰æ•°æ®çš„æ—¥æœŸèŒƒå›´</li>
                                <li>âŒ <strong>æ•°æ®ä¸è¶³</strong>ï¼šæ—¥æœŸèŒƒå›´å¤ªçŸ­ï¼Œæ•°æ®ç‚¹ä¸å¤Ÿï¼ˆç­–ç•¥è‡³å°‘éœ€è¦20-40æ¡æ•°æ®ï¼‰</li>
                                <li>âŒ <strong>ç­–ç•¥æ¡ä»¶æœªè§¦å‘</strong>ï¼šåœ¨é€‰æ‹©çš„æ—¥æœŸèŒƒå›´å†…ï¼Œç­–ç•¥çš„ä¹°å…¥/å–å‡ºæ¡ä»¶æ²¡æœ‰å‘ç”Ÿ</li>
                            </ul>
                            <p style="margin-top: 10px;"><strong>ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š</strong></p>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>âœ… ä½¿ç”¨å†å²æ—¥æœŸèŒƒå›´ï¼ˆå¦‚ï¼š2022-01-01 åˆ° 2023-12-31ï¼‰</li>
                                <li>âœ… ç¡®ä¿æ—¥æœŸèŒƒå›´è‡³å°‘æœ‰3-6ä¸ªæœˆçš„æ•°æ®</li>
                                <li>âœ… æ£€æŸ¥æ ‡çš„æ˜¯å¦æœ‰è¶³å¤Ÿçš„å†å²æ•°æ®</li>
                                <li>âœ… å°è¯•æ›´é•¿çš„æ—¥æœŸèŒƒå›´æˆ–ä¸åŒçš„ç­–ç•¥</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            statsHtml += `</div>`;
            statsContainer.innerHTML = statsHtml;
            
            // æ˜¾ç¤ºæœ€ä½³å‚æ•°
            if (data.best_by_return) {
                const best = data.best_by_return;
                // ç¡®ä¿æ•°å€¼æ­£ç¡®æ˜¾ç¤º
                const totalReturn = parseFloat(best.total_return || 0);
                const annualReturn = parseFloat(best.annual_return || 0);
                const sharpeRatio = parseFloat(best.sharpe_ratio || 0);
                const maxDrawdown = parseFloat(best.max_drawdown || 0);
                const totalTrades = parseInt(best.total_trades || 0);
                
                // è°ƒè¯•ï¼šæ‰“å°æœ€ä½³å‚æ•°æ•°æ®
                console.log('æœ€ä½³å‚æ•°æ•°æ®:', {
                    best: best,
                    totalReturn: totalReturn,
                    totalTrades: totalTrades,
                    annualReturn: annualReturn,
                    sharpeRatio: sharpeRatio
                });
                
                statsContainer.innerHTML += `
                    <div class="stat-card" style="grid-column: 1 / -1; background: #2d2d2d; border: 2px solid #4CAF50; padding: 20px;">
                        <h3 style="color: #4CAF50; margin-top: 0;">ğŸ† æœ€ä½³å‚æ•°ï¼ˆæŒ‰æ€»æ”¶ç›Šç‡ï¼‰</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div>
                                <strong style="color: #ccc;">å‚æ•°ç»„åˆï¼š</strong>
                                <pre style="background: #1e1e1e; padding: 10px; border-radius: 5px; color: #4CAF50; margin-top: 5px; overflow-x: auto;">${JSON.stringify(best.params, null, 2)}</pre>
                            </div>
                            <div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #ccc;">æ€»æ”¶ç›Šç‡ï¼š</strong>
                                    <span style="color: ${totalReturn >= 0 ? '#4CAF50' : '#ef5350'}; font-size: 18px; font-weight: bold;">
                                        ${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%
                                    </span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #ccc;">å¹´åŒ–æ”¶ç›Šç‡ï¼š</strong>
                                    <span style="color: ${annualReturn >= 0 ? '#4CAF50' : '#ef5350'};">
                                        ${annualReturn >= 0 ? '+' : ''}${annualReturn.toFixed(2)}%
                                    </span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #ccc;">å¤æ™®æ¯”ç‡ï¼š</strong>
                                    <span>${sharpeRatio.toFixed(3)}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #ccc;">æœ€å¤§å›æ’¤ï¼š</strong>
                                    <span style="color: #ef5350;">${maxDrawdown.toFixed(2)}%</span>
                                </div>
                                <div>
                                    <strong style="color: #ccc;">äº¤æ˜“æ¬¡æ•°ï¼š</strong>
                                    <span>${totalTrades}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="applyBestParams(${JSON.stringify(best.params).replace(/"/g, '&quot;')})" 
                                style="margin-top: 15px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            âœ… åº”ç”¨æ­¤å‚æ•°
                        </button>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºå‰10ä¸ªæœ€ä½³ç»“æœ
            if (data.top_results && data.top_results.length > 0) {
                let topResultsHtml = `
                    <div class="stat-card" style="grid-column: 1 / -1; background: #2d2d2d; padding: 20px;">
                        <h3 style="color: #4CAF50; margin-top: 0;">ğŸ“Š å‰10ä¸ªæœ€ä½³å‚æ•°ç»„åˆ</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px; min-width: 800px;">
                                <thead>
                                    <tr style="background: #1e1e1e;">
                                        <th style="padding: 10px; text-align: left; border-bottom: 1px solid #444;">æ’å</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 1px solid #444;">å‚æ•°</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 1px solid #444;">æ€»æ”¶ç›Šç‡</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 1px solid #444;">å¹´åŒ–æ”¶ç›Šç‡</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 1px solid #444;">å¤æ™®æ¯”ç‡</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 1px solid #444;">äº¤æ˜“æ¬¡æ•°</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 1px solid #444;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.top_results.forEach((result, index) => {
                    const params = result.strategy_params || {};
                    // ç¡®ä¿æ•°å€¼æ­£ç¡®æ˜¾ç¤ºï¼ˆå¤„ç†å¯èƒ½çš„nullæˆ–undefinedï¼‰
                    const totalReturn = parseFloat(result.total_return_pct || 0);
                    const annualReturn = parseFloat(result.annual_return_pct || 0);
                    const sharpeRatio = parseFloat(result.sharpe_ratio || 0);
                    const totalTrades = parseInt(result.total_trades || 0);
                    
                    // è°ƒè¯•ï¼šæ‰“å°ç¬¬ä¸€ä¸ªç»“æœçš„æ•°æ®
                    if (index === 0) {
                        console.log('ç¬¬ä¸€ä¸ªç»“æœçš„æ•°æ®:', {
                            result: result,
                            total_return_pct: result.total_return_pct,
                            total_trades: result.total_trades,
                            annual_return_pct: result.annual_return_pct,
                            sharpe_ratio: result.sharpe_ratio,
                            parsed_totalReturn: totalReturn,
                            parsed_totalTrades: totalTrades
                        });
                    }
                    
                    topResultsHtml += `
                        <tr style="border-bottom: 1px solid #333;">
                            <td style="padding: 10px;">${index + 1}</td>
                            <td style="padding: 10px;">
                                <code style="font-size: 0.85em; color: #4CAF50;">${JSON.stringify(params)}</code>
                            </td>
                            <td style="padding: 10px; text-align: right; color: ${totalReturn >= 0 ? '#4CAF50' : '#ef5350'};">
                                ${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%
                            </td>
                            <td style="padding: 10px; text-align: right; color: ${annualReturn >= 0 ? '#4CAF50' : '#ef5350'};">
                                ${annualReturn >= 0 ? '+' : ''}${annualReturn.toFixed(2)}%
                            </td>
                            <td style="padding: 10px; text-align: right;">${sharpeRatio.toFixed(3)}</td>
                            <td style="padding: 10px; text-align: right;">${totalTrades}</td>
                            <td style="padding: 10px; text-align: center;">
                                <button onclick="applyBestParams(${JSON.stringify(params).replace(/"/g, '&quot;')})" 
                                        style="padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85em;">
                                    åº”ç”¨
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                topResultsHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                statsContainer.innerHTML += topResultsHtml;
            }
            
            // å¦‚æœæœ€ä½³å‚æ•°æœ‰å›¾è¡¨æ•°æ®ï¼Œæ˜¾ç¤ºæœ€ä½³å‚æ•°çš„æ”¶ç›Šæ›²çº¿
            if (data.best_chart_data && data.best_chart_data.equity_curve && data.best_chart_data.equity_curve.length > 0) {
                console.log('æ˜¾ç¤ºæœ€ä½³å‚æ•°çš„æ”¶ç›Šæ›²çº¿', {
                    equity_curve_length: data.best_chart_data.equity_curve.length,
                    trade_points: data.best_chart_data.trade_points,
                    trade_points_length: (data.best_chart_data.trade_points || []).length,
                    trade_points_type: typeof data.best_chart_data.trade_points,
                    initial_cash: data.best_chart_data.initial_cash
                });
                setTimeout(() => {
                    // ç¡®ä¿ trade_points æ˜¯æ•°ç»„
                    let tradePoints = data.best_chart_data.trade_points;
                    if (!Array.isArray(tradePoints)) {
                        console.warn('trade_points ä¸æ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºæ•°ç»„:', tradePoints);
                        tradePoints = tradePoints ? [tradePoints] : [];
                    }
                    console.log('å‡†å¤‡ç»˜åˆ¶å›¾è¡¨ï¼Œäº¤æ˜“ç‚¹æ•°:', tradePoints.length, 'äº¤æ˜“ç‚¹æ•°æ®:', tradePoints);
                    initEquityChart(
                        data.best_chart_data.equity_curve, 
                        data.best_chart_data.initial_cash, 
                        tradePoints,
                        data.best_chart_data.price_data || []
                    );
                }, 200);
            } else {
                console.log('æ²¡æœ‰å›¾è¡¨æ•°æ®', {
                    has_best_chart_data: !!data.best_chart_data,
                    has_equity_curve: !!(data.best_chart_data && data.best_chart_data.equity_curve),
                    equity_curve_length: data.best_chart_data?.equity_curve?.length || 0
                });
                // å¦‚æœæ²¡æœ‰å›¾è¡¨æ•°æ®ï¼Œæ¸…é™¤ä¹‹å‰çš„å›¾è¡¨
                const chartElement = document.getElementById('resultChart');
                if (chartElement) {
                    chartElement.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">æš‚æ— å›¾è¡¨æ•°æ®</p>';
                }
            }
        }
        
        function applyBestParams(params) {
            // åº”ç”¨æœ€ä½³å‚æ•°åˆ°è¡¨å•
            console.log('Applying params:', params);
            
            // æ›´æ–°å‚æ•°è¾“å…¥æ¡†
            for (const [key, value] of Object.entries(params)) {
                const input = document.getElementById(`param_${key}`);
                if (input) {
                    input.value = value;
                }
            }
            
            alert('å‚æ•°å·²åº”ç”¨åˆ°è¡¨å•ï¼Œå¯ä»¥ç‚¹å‡»"å¼€å§‹å›æµ‹"è¿›è¡ŒéªŒè¯ï¼');
        }
        
        // è¡¨å•æäº¤äº‹ä»¶ï¼ˆå¤‡ç”¨ï¼Œé˜²æ­¢ç”¨æˆ·ç›´æ¥æäº¤è¡¨å•ï¼‰
        const backtestForm = document.getElementById('backtestForm');
        if (backtestForm) {
            backtestForm.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                runBacktest();
            });
        }

        function displayResults(data) {
            const statsContainer = document.getElementById('resultStats');
            const totalReturn = parseFloat(data.total_return || 0);
            const finalValue = parseFloat(data.final_value || 0);
            const initialCash = parseFloat(data.initial_cash || 0);
            const dataTypeText = data.data_type === 'daily' ? 'æ—¥Kæ•°æ®' : `${data.interval || 'åˆ†é’Ÿ'}Kæ•°æ®`;
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">æ•°æ®æ¥æº</div>
                    <div class="stat-value" style="font-size: 20px;">${dataTypeText}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ•°æ®æ¡æ•°</div>
                    <div class="stat-value" style="font-size: 24px;">${data.data_points || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">åˆå§‹èµ„é‡‘</div>
                    <div class="stat-value">Â¥${initialCash.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€ç»ˆä»·å€¼</div>
                    <div class="stat-value">Â¥${finalValue.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ€»æ”¶ç›Šç‡</div>
                    <div class="stat-value ${totalReturn < 0 ? 'negative' : ''}">
                        ${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹´åŒ–æ”¶ç›Šç‡</div>
                    <div class="stat-value ${data.annual_return_pct < 0 ? 'negative' : ''}">
                        ${data.annual_return_pct >= 0 ? '+' : ''}${(data.annual_return_pct || 0).toFixed(2)}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€å¤§å›æ’¤</div>
                    <div class="stat-value negative">${(data.max_drawdown || 0).toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¤æ™®æ¯”ç‡</div>
                    <div class="stat-value">${(data.sharpe_ratio || 0).toFixed(3)}</div>
                </div>
                ${data.total_trades !== undefined ? `
                <div class="stat-card">
                    <div class="stat-label">æ€»äº¤æ˜“æ¬¡æ•°</div>
                    <div class="stat-value">${data.total_trades || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç›ˆåˆ©äº¤æ˜“</div>
                    <div class="stat-value" style="color: #4CAF50;">${data.won_trades || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">äºæŸäº¤æ˜“</div>
                    <div class="stat-value" style="color: #ef5350;">${data.lost_trades || 0}</div>
                </div>
                ` : ''}
            `;
            
            // ç»˜åˆ¶æ”¶ç›Šæ›²çº¿å›¾è¡¨
            console.log('Checking equity_curve data:', {
                hasEquityCurve: !!data.equity_curve,
                length: data.equity_curve ? data.equity_curve.length : 0,
                sample: data.equity_curve ? data.equity_curve.slice(0, 2) : null
            });
            
            if (data.equity_curve && data.equity_curve.length > 0) {
                console.log('Drawing equity chart with', data.equity_curve.length, 'points');
                console.log('Equity curve sample:', data.equity_curve.slice(0, 3));
                
                // ç¡®ä¿å›¾è¡¨å®¹å™¨å¯è§
                const chartElement = document.getElementById('resultChart');
                if (chartElement) {
                    chartElement.style.display = 'block';
                    chartElement.style.visibility = 'visible';
                    console.log('Chart element display set to block');
                }
                
                // å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿DOMå·²æ›´æ–°
                setTimeout(() => {
                    console.log('Calling initEquityChart with data:', {
                        equity_curve_length: data.equity_curve?.length,
                        trade_points_length: data.trade_points?.length,
                        trade_points: data.trade_points
                    });
                    initEquityChart(data.equity_curve, data.initial_cash, data.trade_points || [], data.price_data || []);
                }, 200);
            } else {
                console.warn('No equity curve data available');
                const chartElement = document.getElementById('resultChart');
                if (chartElement) {
                    chartElement.innerHTML = '<div style="padding: 20px; color: #fff; text-align: center;">è­¦å‘Š: æ²¡æœ‰æ”¶ç›Šæ›²çº¿æ•°æ®ã€‚å›æµ‹å¯èƒ½æ²¡æœ‰äº§ç”Ÿäº¤æ˜“è®°å½•ã€‚</div>';
                    chartElement.style.display = 'block';
                }
            }
        }
        
        // åœ¨å…¨å±€ä½œç”¨åŸŸå£°æ˜å›¾è¡¨å®ä¾‹å˜é‡
        var equityChart = null;  // ä¿å­˜å›¾è¡¨å®ä¾‹ï¼Œä»¥ä¾¿åç»­é‡ç”¨
        
        function initEquityChart(equityData, initialCash, tradePoints = [], priceData = []) {
            console.log('initEquityChart called with:', {
                equityDataLength: equityData?.length,
                initialCash: initialCash,
                tradePointsLength: tradePoints?.length,
                tradePoints: tradePoints
            });
            console.log('Initializing equity chart with', equityData.length, 'data points');
            
            // æ£€æŸ¥EChartsæ˜¯å¦å·²åŠ è½½
            if (typeof echarts === 'undefined') {
                console.error('ECharts is not loaded!');
                const chartElement = document.getElementById('resultChart');
                if (chartElement) {
                    chartElement.innerHTML = '<div style="padding: 20px; color: #fff;">é”™è¯¯: EChartsåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
                }
                return;
            }
            
            const chartElement = document.getElementById('resultChart');
            if (!chartElement) {
                console.error('Chart element not found!');
                return;
            }
            
            // å¦‚æœå·²æœ‰å›¾è¡¨å®ä¾‹ï¼Œå…ˆé”€æ¯
            if (equityChart) {
                try {
                    equityChart.dispose();
                } catch (e) {
                    console.warn('Error disposing chart:', e);
                } finally {
                    equityChart = null;
                }
            }
            
            // ç¡®ä¿å›¾è¡¨å®¹å™¨å¯è§å¹¶è®¾ç½®å°ºå¯¸
            chartElement.style.display = 'block';
            chartElement.style.width = '100%';
            chartElement.style.height = '500px';
            chartElement.style.minHeight = '500px';
            
            // åˆå§‹åŒ–æ–°å›¾è¡¨
            try {
                equityChart = echarts.init(chartElement, 'dark');
                console.log('ECharts instance created successfully');
            } catch (e) {
                console.error('Failed to initialize ECharts:', e);
                chartElement.innerHTML = '<div style="padding: 20px; color: #fff;">é”™è¯¯: å›¾è¡¨åˆå§‹åŒ–å¤±è´¥: ' + e.message + '</div>';
                return;
            }
            
            // å‡†å¤‡æ•°æ® - ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
            if (!Array.isArray(equityData) || equityData.length === 0) {
                console.error('Invalid equity data:', equityData);
                chartElement.innerHTML = '<div style="padding: 20px; color: #fff;">é”™è¯¯: æ”¶ç›Šæ›²çº¿æ•°æ®æ— æ•ˆ</div>';
                return;
            }
            
            const dates = equityData.map(d => {
                if (typeof d === 'string') {
                    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
                    const parsed = JSON.parse(d);
                    return parsed.date || d;
                }
                return d.date || d[0] || d;
            });
            const values = equityData.map(d => {
                if (typeof d === 'string') {
                    const parsed = JSON.parse(d);
                    return parseFloat(parsed.value || parsed[1] || 0);
                }
                return parseFloat(d.value || d[1] || 0);
            });
            const returns = equityData.map(d => {
                if (typeof d === 'string') {
                    const parsed = JSON.parse(d);
                    return parseFloat(parsed.return_pct || parsed[2] || 0);
                }
                return parseFloat(d.return_pct || d[2] || 0);
            });
            
            // å¤„ç†Kçº¿æ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            let klineData = [];
            if (priceData && priceData.length > 0) {
                // å‡†å¤‡Kçº¿æ•°æ®æ ¼å¼ï¼šECharts candlestickéœ€è¦ [å¼€ç›˜, æ”¶ç›˜, æœ€ä½, æœ€é«˜]
                // æ³¨æ„ï¼šEChartsçš„candlestickæ•°æ®æ ¼å¼æ˜¯ [open, close, low, high]
                klineData = priceData.map(p => {
                    return [p.open, p.close, p.low, p.high];
                });
                console.log('Kçº¿æ•°æ®å‡†å¤‡å®Œæˆï¼Œå…±', klineData.length, 'æ¡');
                console.log('Kçº¿æ•°æ®ç¤ºä¾‹:', klineData.slice(0, 3));
            }
            
            // å¤„ç†äº¤æ˜“æ—¶ç‚¹æ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦åœ¨è°ƒç”¨initEquityChartæ—¶ä¼ é€’tradePointså‚æ•°
            
            console.log('Chart data sample:', {
                firstDate: dates[0],
                firstValue: values[0],
                firstReturn: returns[0],
                lastValue: values[values.length - 1],
                totalPoints: dates.length,
                tradePoints: tradePoints.length,
                sampleRaw: equityData[0]
            });
            
            // å‡†å¤‡äº¤æ˜“æ ‡è®°ç‚¹æ•°æ®
            const buyPoints = [];
            const sellPoints = [];
            
            console.log('Processing trade points:', {
                count: tradePoints?.length || 0,
                tradePoints: tradePoints,
                datesSample: dates.slice(0, 5),
                valuesSample: values.slice(0, 5)
            });
            
            if (tradePoints && Array.isArray(tradePoints) && tradePoints.length > 0) {
                tradePoints.forEach((tp, idx) => {
                    if (!tp || !tp.date) {
                        console.warn('Invalid trade point at index', idx, tp);
                        return;
                    }
                    
                    // æ ‡å‡†åŒ–æ—¥æœŸæ ¼å¼ï¼ˆåªå–æ—¥æœŸéƒ¨åˆ†ï¼Œå»æ‰æ—¶é—´ï¼‰
                    let tpDateOnly = '';
                    if (typeof tp.date === 'string') {
                        tpDateOnly = tp.date.substring(0, 10);
                    } else {
                        tpDateOnly = String(tp.date).substring(0, 10);
                    }
                    
                    console.log(`Processing trade point ${idx}:`, {
                        originalDate: tp.date,
                        normalizedDate: tpDateOnly,
                        type: tp.type,
                        price: tp.price
                    });
                    
                    // åœ¨datesæ•°ç»„ä¸­æŸ¥æ‰¾åŒ¹é…çš„æ—¥æœŸ
                    let pointIndex = dates.findIndex(d => {
                        const dStr = typeof d === 'string' ? d.substring(0, 10) : String(d).substring(0, 10);
                        return dStr === tpDateOnly;
                    });
                    
                    if (pointIndex >= 0 && pointIndex < values.length) {
                        // å¯¹äºKçº¿å›¾ï¼Œéœ€è¦æ‰¾åˆ°å¯¹åº”çš„ä»·æ ¼ï¼ˆä½¿ç”¨æ”¶ç›˜ä»·ï¼‰
                        let priceForKline = values[pointIndex]; // é»˜è®¤ä½¿ç”¨èµ„äº§ä»·å€¼
                        if (klineData.length > 0 && pointIndex < klineData.length) {
                            // å¦‚æœæœ‰Kçº¿æ•°æ®ï¼Œä½¿ç”¨æ”¶ç›˜ä»·
                            priceForKline = klineData[pointIndex][1]; // [open, close, low, high]ä¸­çš„close
                        }
                        
                        // markPointçš„coordæ ¼å¼ï¼šå¯¹äºcategoryç±»å‹çš„xAxisï¼Œå¯ä»¥ä½¿ç”¨ç´¢å¼•æˆ–æ—¥æœŸå­—ç¬¦ä¸²
                        // ä½¿ç”¨æ—¥æœŸå­—ç¬¦ä¸²æ›´å¯é ï¼Œå› ä¸ºEChartsä¼šè‡ªåŠ¨åŒ¹é…
                        const pointData = {
                            name: tp.type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º',
                            coord: [dates[pointIndex], priceForKline], // ä½¿ç”¨æ—¥æœŸå­—ç¬¦ä¸²å’Œä»·æ ¼
                            value: `${tp.type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'}\nä»·æ ¼: Â¥${(tp.price || 0).toFixed(2)}\nèµ„äº§: Â¥${(tp.value || 0).toFixed(2)}`,
                            itemStyle: { color: tp.type === 'buy' ? '#4CAF50' : '#ef5350' }
                        };
                        
                        if (tp.type === 'buy') {
                            buyPoints.push(pointData);
                            console.log('âœ“ Added buy point:', dates[pointIndex], priceForKline);
                        } else if (tp.type === 'sell') {
                            sellPoints.push(pointData);
                            console.log('âœ“ Added sell point:', dates[pointIndex], priceForKline);
                        }
                    } else {
                        console.warn('âœ— Trade point date not found in chart dates:', {
                            tradeDate: tpDateOnly,
                            firstChartDate: dates[0],
                            lastChartDate: dates[dates.length - 1],
                            totalDates: dates.length
                        });
                    }
                });
            } else {
                console.warn('No trade points to process:', {
                    tradePoints: tradePoints,
                    isArray: Array.isArray(tradePoints),
                    length: tradePoints?.length
                });
            }
            
            console.log('Final mark points:', {
                buyPoints: buyPoints.length,
                sellPoints: sellPoints.length,
                total: buyPoints.length + sellPoints.length,
                buyPointsData: buyPoints,
                sellPointsData: sellPoints
            });
            
            const option = {
                backgroundColor: '#1e1e1e',
                title: {
                    text: 'èµ„äº§ä»·å€¼ä¸æ”¶ç›Šç‡å˜åŒ–æ›²çº¿',
                    subtext: 'å¯æ‹–åŠ¨ä¸‹æ–¹æ»‘å—æŸ¥çœ‹ä¸åŒæ—¶é—´æ®µ',
                    left: 'center',
                    textStyle: { color: '#fff' },
                    subtextStyle: { color: '#999', fontSize: 12 }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    formatter: function(params) {
                        if (!params || params.length === 0) return '';
                        let result = params[0].name + '<br/>';
                        params.forEach(param => {
                            if (!param || param.value === null || param.value === undefined) return;
                            
                            if (param.seriesName === 'åŸºé‡‘å‡€å€¼') {
                                // Kçº¿å›¾tooltipï¼šæ˜¾ç¤ºOHLC
                                if (Array.isArray(param.value) && param.value.length === 4) {
                                    const [open, close, low, high] = param.value;
                                    result += `${param.seriesName}:<br/>`;
                                    result += `  å¼€ç›˜: Â¥${Number(open).toFixed(2)}<br/>`;
                                    result += `  æ”¶ç›˜: Â¥${Number(close).toFixed(2)}<br/>`;
                                    result += `  æœ€ä½: Â¥${Number(low).toFixed(2)}<br/>`;
                                    result += `  æœ€é«˜: Â¥${Number(high).toFixed(2)}<br/>`;
                                }
                            } else if (param.seriesName === 'èµ„äº§ä»·å€¼') {
                                const val = Number(param.value);
                                if (!isNaN(val)) {
                                    result += `${param.seriesName}: Â¥${val.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}<br/>`;
                                }
                            } else {
                                const val = Number(param.value);
                                if (!isNaN(val)) {
                                    result += `${param.seriesName}: ${val >= 0 ? '+' : ''}${val.toFixed(2)}%<br/>`;
                                }
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: klineData.length > 0 ? ['åŸºé‡‘å‡€å€¼', 'èµ„äº§ä»·å€¼', 'æ”¶ç›Šç‡'] : ['èµ„äº§ä»·å€¼', 'æ”¶ç›Šç‡'],
                    top: 30,
                    textStyle: { color: '#fff' }
                },
                grid: [
                    { left: '10%', right: '8%', top: '15%', height: '45%' },  // Kçº¿å›¾åŒºåŸŸ
                    { left: '10%', right: '8%', top: '65%', height: '20%' },  // èµ„äº§ä»·å€¼åŒºåŸŸ
                    { left: '10%', right: '8%', top: '90%', height: '10%' }   // æ”¶ç›Šç‡åŒºåŸŸ
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        axisLabel: { 
                            color: '#999',
                            show: false  // Kçº¿å›¾ä¸æ˜¾ç¤ºXè½´æ ‡ç­¾ï¼Œé¿å…é‡å 
                        }
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { 
                            color: '#999',
                            formatter: function(value, index) {
                                const total = dates.length;
                                if (total > 500) {
                                    return index % Math.ceil(total / 20) === 0 ? value : '';
                                }
                                if (total > 200) {
                                    return index % Math.ceil(total / 15) === 0 ? value : '';
                                }
                                if (total > 100) {
                                    return index % Math.ceil(total / 10) === 0 ? value : '';
                                }
                                return value;
                            }
                        }
                    },
                    {
                        type: 'category',
                        gridIndex: 2,
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    }
                ],
                yAxis: [
                    {
                        type: 'value',
                        name: 'åŸºé‡‘å‡€å€¼ (Â¥)',
                        scale: true,
                        splitArea: { show: true },
                        axisLabel: { 
                            color: '#999',
                            formatter: function(value) {
                                return value.toFixed(2);
                            }
                        }
                    },
                    {
                        type: 'value',
                        name: 'èµ„äº§ä»·å€¼ (Â¥)',
                        gridIndex: 1,
                        scale: true,
                        splitArea: { show: true },
                        axisLabel: { 
                            color: '#999',
                            formatter: function(value) {
                                return 'Â¥' + (value / 10000).toFixed(1) + 'ä¸‡';
                            }
                        }
                    },
                    {
                        type: 'value',
                        name: 'æ”¶ç›Šç‡ (%)',
                        gridIndex: 2,
                        scale: true,
                        splitNumber: 2,
                        axisLabel: { 
                            color: '#999',
                            formatter: '{value}%'
                        },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1, 2],
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        xAxisIndex: [0, 1, 2],
                        type: 'slider',
                        top: '95%',
                        start: 0,
                        end: 100,
                        textStyle: { color: '#999' }
                    }
                ],
                series: [
                    // Kçº¿å›¾ï¼ˆåŸºé‡‘å‡€å€¼ï¼‰- å¦‚æœæœ‰Kçº¿æ•°æ®
                    ...(klineData.length > 0 ? [{
                        name: 'åŸºé‡‘å‡€å€¼',
                        type: 'candlestick',
                        data: klineData,  // æ ¼å¼ï¼š[å¼€ç›˜, æ”¶ç›˜, æœ€ä½, æœ€é«˜]
                        itemStyle: {
                            color: '#26a69a',      // ä¸Šæ¶¨é¢œè‰²ï¼ˆç»¿è‰²ï¼‰
                            color0: '#ef5350',     // ä¸‹è·Œé¢œè‰²ï¼ˆçº¢è‰²ï¼‰
                            borderColor: '#26a69a',
                            borderColor0: '#ef5350'
                        },
                        markPoint: (buyPoints.length > 0 || sellPoints.length > 0) ? {
                            data: [
                                ...buyPoints,
                                ...sellPoints
                            ],
                            symbol: 'circle',
                            symbolSize: 25,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: function(params) {
                                    return params.data.name || params.name || '';
                                },
                                fontSize: 12,
                                color: '#fff',
                                fontWeight: 'bold',
                                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                                padding: [4, 8],
                                borderRadius: 4
                            },
                            itemStyle: {
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            emphasis: {
                                label: {
                                    show: true
                                },
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowColor: 'rgba(255, 255, 255, 0.5)'
                                }
                            }
                        } : undefined
                    }] : []),
                    // èµ„äº§ä»·å€¼æ›²çº¿
                    {
                        name: 'èµ„äº§ä»·å€¼',
                        type: 'line',
                        yAxisIndex: klineData.length > 0 ? 1 : 0,
                        xAxisIndex: klineData.length > 0 ? 1 : 0,
                        data: values,
                        smooth: true,
                        lineStyle: { width: 2, color: '#4CAF50' },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(76, 175, 80, 0.3)' },
                                    { offset: 1, color: 'rgba(76, 175, 80, 0.1)' }
                                ]
                            }
                        },
                        markLine: {
                            data: [
                                { yAxis: initialCash, name: 'åˆå§‹èµ„é‡‘', lineStyle: { color: '#999', type: 'dashed' } }
                            ]
                        },
                        showSymbol: false
                    },
                    // æ”¶ç›Šç‡æ›²çº¿
                    {
                        name: 'æ”¶ç›Šç‡',
                        type: 'line',
                        yAxisIndex: klineData.length > 0 ? 2 : 1,
                        xAxisIndex: klineData.length > 0 ? 2 : 1,
                        data: returns,
                        smooth: true,
                        lineStyle: { width: 1, color: '#26a69a' },
                        showSymbol: false
                    }
                ]
            };
            
            try {
                console.log('Setting ECharts option with', dates.length, 'data points');
                equityChart.setOption(option, true);  // notMerge=trueï¼Œå®Œå…¨æ›¿æ¢
                console.log('ECharts option set successfully');
                
                // å¼ºåˆ¶è°ƒæ•´å¤§å°ä»¥ç¡®ä¿å›¾è¡¨æ­£ç¡®æ˜¾ç¤º
                setTimeout(() => {
                    try {
                        if (equityChart && chartElement && chartElement.offsetWidth > 0) {
                            equityChart.resize();
                            console.log('Chart resized after initialization');
                        }
                        // å†æ¬¡æ£€æŸ¥å›¾è¡¨æ˜¯å¦æ¸²æŸ“
                        const chartContainer = document.getElementById('resultChart');
                        if (chartContainer) {
                            console.log('Chart container check:', {
                                childrenCount: chartContainer.children.length,
                                offsetWidth: chartContainer.offsetWidth,
                                offsetHeight: chartContainer.offsetHeight
                            });
                            if (chartContainer.children.length === 0) {
                                console.warn('Chart container is still empty after initialization');
                            }
                        }
                    } catch (e) {
                        console.warn('Error in chart resize check:', e);
                    }
                }, 300);
                
                // æ·»åŠ ä¸€ä¸ªæ›´é•¿çš„å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿å›¾è¡¨æ¸²æŸ“
                setTimeout(() => {
                    const chartContainer = document.getElementById('resultChart');
                    if (chartContainer) {
                        const canvas = chartContainer.querySelector('canvas');
                        const svg = chartContainer.querySelector('svg');
                        console.log('Chart render check:', {
                            hasCanvas: !!canvas,
                            hasSvg: !!svg,
                            childrenCount: chartContainer.children.length,
                            offsetWidth: chartContainer.offsetWidth,
                            offsetHeight: chartContainer.offsetHeight
                        });
                        
                        if (!canvas && !svg) {
                            console.error('Chart canvas/svg not found! Chart may not have rendered.');
                            chartElement.innerHTML = '<div style="padding: 20px; color: #fff; text-align: center;">è­¦å‘Š: å›¾è¡¨æœªèƒ½æ­£ç¡®æ¸²æŸ“<br/>è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯<br/>æˆ–åˆ·æ–°é¡µé¢é‡è¯•</div>';
                        } else {
                            console.log('Chart canvas/svg found, chart should be visible');
                            // ç¡®ä¿å›¾è¡¨å¯è§
                            if (canvas) canvas.style.display = 'block';
                            if (svg) svg.style.display = 'block';
                        }
                    }
                }, 800);
                
                // å¤„ç†çª—å£å¤§å°å˜åŒ–
                const resizeHandler = () => {
                    try {
                        const chartContainer = document.getElementById('resultChart');
                        if (equityChart && chartContainer && chartContainer.offsetWidth > 0) {
                            equityChart.resize();
                        }
                    } catch (e) {
                        console.warn('Error in resize handler:', e);
                    }
                };
                // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (window.equityChartResizeHandler) {
                    window.removeEventListener('resize', window.equityChartResizeHandler);
                }
                window.equityChartResizeHandler = resizeHandler;
                window.addEventListener('resize', resizeHandler);
                
                console.log('Equity chart initialized successfully with', dates.length, 'data points');
            } catch (e) {
                console.error('Failed to set chart option:', e);
                chartElement.innerHTML = '<div style="padding: 20px; color: #fff;">é”™è¯¯: å›¾è¡¨æ¸²æŸ“å¤±è´¥: ' + e.message + '</div>';
            }
        }
    </script>
</body>
</html>

