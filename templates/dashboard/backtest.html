<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>策略回测系统</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1e1e1e;
            color: #fff;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4CAF50;
        }
        .header h1 {
            margin: 0;
            color: #fff;
        }
        .nav-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .nav-btn:hover {
            background-color: #45a049;
        }
        .backtest-form {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #555;
            background-color: #1e1e1e;
            color: #fff;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .strategy-params {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 4px;
            margin-top: 15px;
            border: 1px solid #444;
            display: none;
        }
        .strategy-params.active {
            display: block;
        }
        .strategy-params h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        .param-group {
            margin-bottom: 0;
        }
        .param-group label {
            display: block;
            color: #ccc;
            font-size: 0.9em;
        }
        .param-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #555;
            background-color: #2d2d2d;
            color: #fff;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn-run {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
        }
        .btn-run:hover {
            background-color: #45a049;
        }
        .btn-run:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .result-container {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 30px;
            margin-top: 30px;
            display: none;
        }
        .result-container.active {
            display: block;
        }
        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-label {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-value.negative {
            color: #ef5350;
        }
        .result-chart {
            width: 100% !important;
            height: 500px !important;
            min-height: 500px;
            background-color: #1e1e1e;
            border-radius: 4px;
            margin-top: 20px;
            position: relative;
            display: block !important;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
            display: none;
        }
        .loading.active {
            display: block;
        }
        .error {
            background-color: #ef5350;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
        }
        .error.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>策略回测系统</h1>
            <a href="{% url 'index' %}" class="nav-btn">返回首页</a>
        </div>

        <div class="backtest-form">
            <form id="backtestForm" onsubmit="return false;">
                {% csrf_token %}
                <div class="form-row">
                    <div class="form-group">
                        <label>选择标的</label>
                        <select name="symbol" id="symbol" required>
                            <option value="">请选择标的</option>
                            {% for instrument in instruments %}
                            <option value="{{ instrument.symbol }}">{{ instrument.symbol }} - {{ instrument.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>选择策略</label>
                        <select name="strategy" id="strategy" required>
                            <option value="">请选择策略</option>
                            {% for key, strategy in strategies.items %}
                            <option value="{{ key }}" data-description="{{ strategy.description }}">{{ strategy.name }} - {{ strategy.description }}</option>
                            {% endfor %}
                        </select>
                        <div id="strategyDescription" style="margin-top: 8px; color: #999; font-size: 0.9em; display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label>开始日期</label>
                        <input type="date" name="start_date" id="start_date" required>
                    </div>
                    <div class="form-group">
                        <label>结束日期</label>
                        <input type="date" name="end_date" id="end_date" required>
                    </div>
                    <div class="form-group">
                        <label>初始资金</label>
                        <input type="number" name="initial_cash" id="initial_cash" value="100000" min="1000" step="1000" required>
                    </div>
                    <div class="form-group">
                        <label>手续费率 (%)</label>
                        <input type="number" name="commission" id="commission" value="0.1" min="0" max="10" step="0.01" required>
                    </div>
                </div>

                <div class="strategy-params" id="strategyParams">
                    <!-- 策略参数将动态加载到这里 -->
                </div>

                <button type="button" class="btn-run" id="btnRun" onclick="runBacktest()">开始回测</button>
            </form>
        </div>

        <div class="loading" id="loading">
            <p>正在运行回测，请稍候...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="result-container" id="resultContainer">
            <h2>回测结果</h2>
            <div class="result-stats" id="resultStats">
                <!-- 统计结果将显示在这里 -->
            </div>
            <div class="result-chart" id="resultChart"></div>
        </div>
    </div>

    <script>
        console.log('Backtest page loaded');
        const strategies = {{ strategies_json|safe }};
        
        // 策略参数详细说明
        const paramDescriptions = {
            'fast_period': {
                title: '短期均线周期',
                description: '计算短期移动平均线的天数。数值越小越敏感，常用值：5（日K）、12（日K）。短期均线能快速反应价格变化。'
            },
            'slow_period': {
                title: '长期均线周期',
                description: '计算长期移动平均线的天数。数值越大越平滑，常用值：20（日K）、26（日K）、60（日K）。长期均线代表趋势方向。'
            },
            'mid_period': {
                title: '中期均线周期',
                description: '计算中期移动平均线的天数。介于短期和长期之间，常用值：10（日K）、20（日K）。用于过滤短期波动。'
            },
            'period': {
                title: '周期参数',
                description: '技术指标的统计周期。对于RSI：常用14，范围6-21；对于布林带：常用20，范围10-30；对于均线：常用20，范围5-60。周期越长越稳定但反应越慢。'
            },
            'signal_period': {
                title: '信号线周期',
                description: 'MACD策略中信号线的平滑周期。常用值：9。用于产生买入/卖出信号，数值越小信号越多但可能产生噪音。'
            },
            'oversold': {
                title: '超卖阈值',
                description: 'RSI指标的超卖线。常用值：30（RSI范围0-100）。当RSI低于此值时，认为股票被过度卖出，可能出现反弹，触发买入信号。可调整范围：20-40。'
            },
            'overbought': {
                title: '超买阈值',
                description: 'RSI指标的超买线。常用值：70（RSI范围0-100）。当RSI高于此值时，认为股票被过度买入，可能回调，触发卖出信号。可调整范围：60-80。'
            },
            'devfactor': {
                title: '标准差倍数',
                description: '布林带宽度参数。常用值：2.0。数值越大，布林带越宽，买入/卖出信号越少但更可靠。常用范围：1.5-2.5。数值小=敏感，数值大=保守。'
            },
            'threshold': {
                title: '偏离阈值',
                description: '价格偏离均线的百分比阈值（小数形式）。例如0.02表示2%，0.05表示5%。当价格低于均线此百分比时买入，高于此百分比时卖出。常用范围：0.01-0.05。'
            },
            'lookback': {
                title: '回看周期',
                description: '计算波动率和成交量的回看天数。用于VCP策略中计算历史波动率和成交量基准。常用值：20。周期越长，基准越稳定但反应越慢。'
            },
            'contraction_ratio': {
                title: '波动收缩比例',
                description: 'VCP策略中波动收缩的阈值（小数形式）。例如0.7表示当前波动小于历史波动的70%时认为发生收缩。常用值：0.6-0.8。数值越小要求越严格。'
            },
            'volume_ratio': {
                title: '成交量收缩比例',
                description: 'VCP策略中成交量收缩的阈值（小数形式）。例如0.8表示当前成交量小于历史均量的80%时认为成交量收缩。常用值：0.7-0.9。数值越小要求越严格。'
            },
            'breakout_threshold': {
                title: '突破阈值',
                description: '价格突破的百分比阈值（倍数形式）。例如1.02表示价格突破前高的2%时触发买入。常用值：1.01-1.05。数值越大要求突破越强。'
            },
            'pattern_type': {
                title: '形态类型',
                description: '蜡烛图策略中要识别的形态类型。可选值：all（所有形态）、hammer（锤子线）、engulfing（吞没形态）、doji（十字星）。推荐使用all以捕捉更多机会。'
            },
            'confirmation_period': {
                title: '确认周期',
                description: '蜡烛图形态出现后，需要等待多少个交易日确认。用于过滤虚假信号。常用值：1-3。周期越长信号越可靠但可能错过最佳入场点。'
            },
            'min_body_ratio': {
                title: '最小实体比例',
                description: '蜡烛图实体占整个K线范围的最小比例（小数形式）。用于识别锤子线等形态。常用值：0.2-0.4。数值越小，识别标准越宽松。'
            },
            'min_shadow_ratio': {
                title: '最小影线比例',
                description: '影线相对于实体的最小倍数。用于识别锤子线，例如2.0表示影线至少是实体的2倍。常用值：1.5-3.0。数值越大要求影线越长。'
            },
            'swing_period': {
                title: '波段周期',
                description: '计算波段高点和低点的周期。用于波段交易策略中识别支撑位和阻力位。常用值：10-20。周期越长，支撑/阻力位越可靠。'
            },
            'pullback_ratio': {
                title: '回调比例',
                description: '价格回调的百分比阈值（小数形式）。例如0.05表示价格从高点回调5%时买入。常用值：0.03-0.08。数值越大买入机会越多但可能买入过早。'
            },
            'profit_target': {
                title: '盈利目标',
                description: '波段交易的盈利目标（小数形式）。例如0.10表示盈利10%时卖出。常用值：0.05-0.15。数值越大目标越高但可能错过卖出机会。'
            },
            'stop_loss': {
                title: '止损比例',
                description: '波段交易的止损比例（小数形式）。例如0.05表示亏损5%时止损。常用值：0.03-0.08。数值越大能承受更多波动但亏损可能更大。'
            },
            'adx_period': {
                title: 'ADX周期',
                description: 'ADX指标的计算周期。ADX用于确认趋势强度。常用值：14。周期越长ADX越平滑但反应越慢。'
            },
            'adx_threshold': {
                title: 'ADX阈值',
                description: 'ADX指标的最低阈值，超过此值认为趋势强劲。常用值：20-30。数值越大要求趋势越强，信号越可靠但机会越少。'
            },
            'trailing_stop': {
                title: '追踪止损',
                description: '趋势跟踪策略的追踪止损比例（小数形式）。例如0.03表示从最高点回撤3%时卖出。常用值：0.02-0.05。数值越大能承受更多波动但可能回吐更多利润。'
            },
        };
        
        // 策略选择变化时，显示/隐藏参数和说明
        document.getElementById('strategy').addEventListener('change', function() {
            const selectedStrategy = this.value;
            const paramsContainer = document.getElementById('strategyParams');
            const descriptionDiv = document.getElementById('strategyDescription');
            const selectedOption = this.options[this.selectedIndex];
            
            if (selectedStrategy && strategies[selectedStrategy]) {
                const strategy = strategies[selectedStrategy];
                
                // 显示策略说明
                descriptionDiv.textContent = strategy.description;
                descriptionDiv.style.display = 'block';
                
                // 生成参数输入框
                let html = '<h3 style="color: #4CAF50; margin-bottom: 15px;">策略参数配置</h3>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">';
                
                for (const [key, value] of Object.entries(strategy.params)) {
                    const inputType = typeof value === 'number' ? 'number' : 'text';
                    const step = typeof value === 'number' && value % 1 !== 0 ? '0.01' : '1';
                    const paramInfo = paramDescriptions[key];
                    const paramName = key.replace(/_/g, ' ');
                    
                    // 如果参数说明是对象，使用详细说明；否则使用简单字符串
                    let title, description;
                    if (paramInfo && typeof paramInfo === 'object' && paramInfo.title) {
                        title = paramInfo.title;
                        description = paramInfo.description || '';
                    } else {
                        title = paramInfo && typeof paramInfo === 'string' ? paramInfo : `${key}参数`;
                        description = '';
                    }
                    
                    html += `
                        <div class="param-group" style="display: flex; flex-direction: column; background-color: #1e1e1e; padding: 15px; border-radius: 5px; border: 1px solid #333;">
                            <label style="margin-bottom: 8px; color: #4CAF50; font-weight: bold; font-size: 1em;">${paramName}</label>
                            <input type="${inputType}" 
                                   name="param_${key}" 
                                   value="${value}" 
                                   step="${step}"
                                   style="width: 100%; padding: 8px; margin-bottom: 8px; background-color: #2d2d2d; border: 1px solid #555; color: #fff; border-radius: 4px;">
                            <div style="color: #ccc; font-size: 0.9em; font-weight: 500; margin-bottom: 5px;">${title}</div>
                            ${description ? `<div style="color: #999; font-size: 0.85em; line-height: 1.4; margin-bottom: 5px;">${description}</div>` : ''}
                        </div>
                    `;
                }
                html += '</div>';
                
                paramsContainer.innerHTML = html;
                paramsContainer.classList.add('active');
            } else {
                descriptionDiv.style.display = 'none';
                paramsContainer.classList.remove('active');
            }
        });

        // 设置默认日期（最近1年）
        const today = new Date();
        const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
        document.getElementById('end_date').value = today.toISOString().split('T')[0];
        document.getElementById('start_date').value = oneYearAgo.toISOString().split('T')[0];
        
        // 数据粒度选择变化
        document.getElementById('data_type').addEventListener('change', function() {
            const intervalGroup = document.getElementById('intervalGroup');
            const dataTypeHint = document.getElementById('dataTypeHint');
            
            if (this.value === 'minute') {
                intervalGroup.style.display = 'block';
                dataTypeHint.textContent = '分钟K数据适用于短期策略和日内交易回测，数据量大';
            } else {
                intervalGroup.style.display = 'none';
                dataTypeHint.textContent = '日K数据适用于长期策略回测，数据更稳定';
            }
        });

        // 回测函数
        function runBacktest() {
            console.log('runBacktest() called');
            
            const backtestForm = document.getElementById('backtestForm');
            if (!backtestForm) {
                console.error('Form not found!');
                return;
            }
            
            const btnRun = document.getElementById('btnRun');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const resultContainer = document.getElementById('resultContainer');
            
            // 显示加载状态
            btnRun.disabled = true;
            loading.classList.add('active');
            loading.style.display = 'block';
            error.classList.remove('active');
            error.style.display = 'none';
            resultContainer.classList.remove('active');
            resultContainer.style.display = 'none';
            
            // 清空之前的图表
            const chartElement = document.getElementById('resultChart');
            if (chartElement) {
                // 先销毁旧的图表实例，避免内存泄漏
                if (typeof equityChart !== 'undefined' && equityChart !== null) {
                    try {
                        equityChart.dispose();
                    } catch (e) {
                        console.warn('Error disposing old chart:', e);
                    }
                    equityChart = null;
                }
                // 清空图表容器
                try {
                    chartElement.innerHTML = '';
                } catch (e) {
                    console.warn('Error clearing chart element:', e);
                }
            }
            
            console.log('Starting backtest...');  // 调试日志
            
            // 收集表单数据
            const formData = new FormData(backtestForm);
            // 将手续费从百分比转换为小数
            const commissionValue = formData.get('commission');
            console.log('Commission value:', commissionValue);
            formData.set('commission', parseFloat(commissionValue) / 100);
            
            // 获取CSRF token
            const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfTokenElement) {
                console.error('CSRF token not found!');
                error.textContent = '错误: CSRF token未找到，请刷新页面重试';
                error.classList.add('active');
                loading.classList.remove('active');
                btnRun.disabled = false;
                return;
            }
            const csrfToken = csrfTokenElement.value;
            console.log('CSRF token:', csrfToken ? 'Found' : 'Not found');
            console.log('Form data:', Array.from(formData.entries()));
            
            // 发送请求
            const apiUrl = '{% url "backtest_api" %}';
            console.log('Sending POST request to:', apiUrl);
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => {
                // 检查响应类型
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    // 如果不是JSON，尝试读取文本
                    return response.text().then(text => {
                        console.error('Server response:', text);
                        throw new Error('服务器返回了非JSON响应，可能是错误页面');
                    });
                }
            })
            .then(data => {
                console.log('Backtest response received:', data);
                loading.classList.remove('active');
                loading.style.display = 'none';
                btnRun.disabled = false;
                
                if (data.error) {
                    console.error('Backtest error:', data.error);
                    error.textContent = '错误: ' + data.error;
                    error.style.display = 'block';
                    error.classList.add('active');
                    return;
                }
                
                // 显示结果
                console.log('Displaying results, equity_curve length:', data.equity_curve ? data.equity_curve.length : 0);
                console.log('Result data:', {
                    total_return: data.total_return,
                    final_value: data.final_value,
                    equity_curve_points: data.equity_curve ? data.equity_curve.length : 0
                });
                
                // 确保结果容器可见
                resultContainer.style.display = 'block';
                resultContainer.classList.add('active');
                
                // 显示结果
                displayResults(data);
                
                // 滚动到结果区域
                setTimeout(() => {
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            })
            .catch(err => {
                loading.classList.remove('active');
                btnRun.disabled = false;
                error.textContent = '错误: ' + (err.message || '回测执行失败，请检查参数和数据');
                error.classList.add('active');
                console.error('Backtest error:', err);
            });
        }
        
        // 表单提交事件（备用，防止用户直接提交表单）
        const backtestForm = document.getElementById('backtestForm');
        if (backtestForm) {
            backtestForm.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                runBacktest();
            });
        }

        function displayResults(data) {
            const statsContainer = document.getElementById('resultStats');
            const totalReturn = parseFloat(data.total_return || 0);
            const finalValue = parseFloat(data.final_value || 0);
            const initialCash = parseFloat(data.initial_cash || 0);
            const dataTypeText = data.data_type === 'daily' ? '日K数据' : `${data.interval || '分钟'}K数据`;
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">数据来源</div>
                    <div class="stat-value" style="font-size: 20px;">${dataTypeText}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">数据条数</div>
                    <div class="stat-value" style="font-size: 24px;">${data.data_points || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">初始资金</div>
                    <div class="stat-value">¥${initialCash.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">最终价值</div>
                    <div class="stat-value">¥${finalValue.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">总收益率</div>
                    <div class="stat-value ${totalReturn < 0 ? 'negative' : ''}">
                        ${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">年化收益率</div>
                    <div class="stat-value ${data.annual_return_pct < 0 ? 'negative' : ''}">
                        ${data.annual_return_pct >= 0 ? '+' : ''}${(data.annual_return_pct || 0).toFixed(2)}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">最大回撤</div>
                    <div class="stat-value negative">${(data.max_drawdown || 0).toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">夏普比率</div>
                    <div class="stat-value">${(data.sharpe_ratio || 0).toFixed(3)}</div>
                </div>
                ${data.total_trades !== undefined ? `
                <div class="stat-card">
                    <div class="stat-label">总交易次数</div>
                    <div class="stat-value">${data.total_trades || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">盈利交易</div>
                    <div class="stat-value" style="color: #4CAF50;">${data.won_trades || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">亏损交易</div>
                    <div class="stat-value" style="color: #ef5350;">${data.lost_trades || 0}</div>
                </div>
                ` : ''}
            `;
            
            // 绘制收益曲线图表
            console.log('Checking equity_curve data:', {
                hasEquityCurve: !!data.equity_curve,
                length: data.equity_curve ? data.equity_curve.length : 0,
                sample: data.equity_curve ? data.equity_curve.slice(0, 2) : null
            });
            
            if (data.equity_curve && data.equity_curve.length > 0) {
                console.log('Drawing equity chart with', data.equity_curve.length, 'points');
                console.log('Equity curve sample:', data.equity_curve.slice(0, 3));
                
                // 确保图表容器可见
                const chartElement = document.getElementById('resultChart');
                if (chartElement) {
                    chartElement.style.display = 'block';
                    chartElement.style.visibility = 'visible';
                    console.log('Chart element display set to block');
                }
                
                // 延迟一下确保DOM已更新
                setTimeout(() => {
                    console.log('Calling initEquityChart with data:', {
                        equity_curve_length: data.equity_curve?.length,
                        trade_points_length: data.trade_points?.length,
                        trade_points: data.trade_points
                    });
                    initEquityChart(data.equity_curve, data.initial_cash, data.trade_points || []);
                }, 200);
            } else {
                console.warn('No equity curve data available');
                const chartElement = document.getElementById('resultChart');
                if (chartElement) {
                    chartElement.innerHTML = '<div style="padding: 20px; color: #fff; text-align: center;">警告: 没有收益曲线数据。回测可能没有产生交易记录。</div>';
                    chartElement.style.display = 'block';
                }
            }
        }
        
        // 在全局作用域声明图表实例变量
        var equityChart = null;  // 保存图表实例，以便后续重用
        
        function initEquityChart(equityData, initialCash, tradePoints = []) {
            console.log('initEquityChart called with:', {
                equityDataLength: equityData?.length,
                initialCash: initialCash,
                tradePointsLength: tradePoints?.length,
                tradePoints: tradePoints
            });
            console.log('Initializing equity chart with', equityData.length, 'data points');
            
            // 检查ECharts是否已加载
            if (typeof echarts === 'undefined') {
                console.error('ECharts is not loaded!');
                const chartElement = document.getElementById('resultChart');
                if (chartElement) {
                    chartElement.innerHTML = '<div style="padding: 20px; color: #fff;">错误: ECharts库未加载，请刷新页面重试</div>';
                }
                return;
            }
            
            const chartElement = document.getElementById('resultChart');
            if (!chartElement) {
                console.error('Chart element not found!');
                return;
            }
            
            // 如果已有图表实例，先销毁
            if (equityChart) {
                try {
                    equityChart.dispose();
                } catch (e) {
                    console.warn('Error disposing chart:', e);
                } finally {
                    equityChart = null;
                }
            }
            
            // 确保图表容器可见并设置尺寸
            chartElement.style.display = 'block';
            chartElement.style.width = '100%';
            chartElement.style.height = '500px';
            chartElement.style.minHeight = '500px';
            
            // 初始化新图表
            try {
                equityChart = echarts.init(chartElement, 'dark');
                console.log('ECharts instance created successfully');
            } catch (e) {
                console.error('Failed to initialize ECharts:', e);
                chartElement.innerHTML = '<div style="padding: 20px; color: #fff;">错误: 图表初始化失败: ' + e.message + '</div>';
                return;
            }
            
            // 准备数据 - 确保数据格式正确
            if (!Array.isArray(equityData) || equityData.length === 0) {
                console.error('Invalid equity data:', equityData);
                chartElement.innerHTML = '<div style="padding: 20px; color: #fff;">错误: 收益曲线数据无效</div>';
                return;
            }
            
            const dates = equityData.map(d => {
                if (typeof d === 'string') {
                    // 如果是字符串，尝试解析
                    const parsed = JSON.parse(d);
                    return parsed.date || d;
                }
                return d.date || d[0] || d;
            });
            const values = equityData.map(d => {
                if (typeof d === 'string') {
                    const parsed = JSON.parse(d);
                    return parseFloat(parsed.value || parsed[1] || 0);
                }
                return parseFloat(d.value || d[1] || 0);
            });
            const returns = equityData.map(d => {
                if (typeof d === 'string') {
                    const parsed = JSON.parse(d);
                    return parseFloat(parsed.return_pct || parsed[2] || 0);
                }
                return parseFloat(d.return_pct || d[2] || 0);
            });
            
            // 处理交易时点数据（如果存在）
            // 注意：这里需要在调用initEquityChart时传递tradePoints参数
            
            console.log('Chart data sample:', {
                firstDate: dates[0],
                firstValue: values[0],
                firstReturn: returns[0],
                lastValue: values[values.length - 1],
                totalPoints: dates.length,
                tradePoints: tradePoints.length,
                sampleRaw: equityData[0]
            });
            
            // 准备交易标记点数据
            const buyPoints = [];
            const sellPoints = [];
            
            console.log('Processing trade points:', {
                count: tradePoints?.length || 0,
                tradePoints: tradePoints,
                datesSample: dates.slice(0, 5),
                valuesSample: values.slice(0, 5)
            });
            
            if (tradePoints && Array.isArray(tradePoints) && tradePoints.length > 0) {
                tradePoints.forEach((tp, idx) => {
                    if (!tp || !tp.date) {
                        console.warn('Invalid trade point at index', idx, tp);
                        return;
                    }
                    
                    // 标准化日期格式（只取日期部分，去掉时间）
                    let tpDateOnly = '';
                    if (typeof tp.date === 'string') {
                        tpDateOnly = tp.date.substring(0, 10);
                    } else {
                        tpDateOnly = String(tp.date).substring(0, 10);
                    }
                    
                    console.log(`Processing trade point ${idx}:`, {
                        originalDate: tp.date,
                        normalizedDate: tpDateOnly,
                        type: tp.type,
                        price: tp.price
                    });
                    
                    // 在dates数组中查找匹配的日期
                    let pointIndex = dates.findIndex(d => {
                        const dStr = typeof d === 'string' ? d.substring(0, 10) : String(d).substring(0, 10);
                        return dStr === tpDateOnly;
                    });
                    
                    if (pointIndex >= 0 && pointIndex < values.length) {
                        const pointData = {
                            name: tp.type === 'buy' ? '买入' : '卖出',
                            coord: [dates[pointIndex], values[pointIndex]],
                            value: `${tp.type === 'buy' ? '买入' : '卖出'}\n价格: ¥${(tp.price || 0).toFixed(2)}\n资产: ¥${(tp.value || 0).toFixed(2)}`,
                            itemStyle: { color: tp.type === 'buy' ? '#4CAF50' : '#ef5350' }
                        };
                        
                        if (tp.type === 'buy') {
                            buyPoints.push(pointData);
                            console.log('✓ Added buy point:', dates[pointIndex], values[pointIndex]);
                        } else if (tp.type === 'sell') {
                            sellPoints.push(pointData);
                            console.log('✓ Added sell point:', dates[pointIndex], values[pointIndex]);
                        }
                    } else {
                        console.warn('✗ Trade point date not found in chart dates:', {
                            tradeDate: tpDateOnly,
                            firstChartDate: dates[0],
                            lastChartDate: dates[dates.length - 1],
                            totalDates: dates.length
                        });
                    }
                });
            } else {
                console.warn('No trade points to process:', {
                    tradePoints: tradePoints,
                    isArray: Array.isArray(tradePoints),
                    length: tradePoints?.length
                });
            }
            
            console.log('Final mark points:', {
                buyPoints: buyPoints.length,
                sellPoints: sellPoints.length,
                total: buyPoints.length + sellPoints.length,
                buyPointsData: buyPoints,
                sellPointsData: sellPoints
            });
            
            const option = {
                backgroundColor: '#1e1e1e',
                title: {
                    text: '资产价值与收益率变化曲线',
                    subtext: '可拖动下方滑块查看不同时间段',
                    left: 'center',
                    textStyle: { color: '#fff' },
                    subtextStyle: { color: '#999', fontSize: 12 }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(param => {
                            if (param.seriesName === '资产价值') {
                                result += `${param.seriesName}: ¥${param.value.toLocaleString('zh-CN', {minimumFractionDigits: 2})}<br/>`;
                            } else {
                                result += `${param.seriesName}: ${param.value >= 0 ? '+' : ''}${param.value.toFixed(2)}%<br/>`;
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['资产价值', '收益率'],
                    top: 30,
                    textStyle: { color: '#fff' }
                },
                grid: [
                    { left: '10%', right: '8%', top: '15%', height: '60%' },
                    { left: '10%', right: '8%', top: '80%', height: '15%' }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        axisLabel: { 
                            color: '#999',
                            formatter: function(value, index) {
                                const total = dates.length;
                                if (total > 500) {
                                    return index % Math.ceil(total / 20) === 0 ? value : '';
                                }
                                if (total > 200) {
                                    return index % Math.ceil(total / 15) === 0 ? value : '';
                                }
                                if (total > 100) {
                                    return index % Math.ceil(total / 10) === 0 ? value : '';
                                }
                                return value;
                            }
                        }
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    }
                ],
                yAxis: [
                    {
                        type: 'value',
                        name: '资产价值 (¥)',
                        scale: true,
                        splitArea: { show: true },
                        axisLabel: { 
                            color: '#999',
                            formatter: function(value) {
                                return '¥' + (value / 10000).toFixed(1) + '万';
                            }
                        }
                    },
                    {
                        type: 'value',
                        name: '收益率 (%)',
                        gridIndex: 1,
                        scale: true,
                        splitNumber: 2,
                        axisLabel: { 
                            color: '#999',
                            formatter: '{value}%'
                        },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1],
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        xAxisIndex: [0, 1],
                        type: 'slider',
                        top: '95%',
                        start: 0,
                        end: 100,
                        textStyle: { color: '#999' }
                    }
                ],
                series: [
                    {
                        name: '资产价值',
                        type: 'line',
                        data: values,
                        smooth: true,
                        lineStyle: { width: 2, color: '#4CAF50' },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(76, 175, 80, 0.3)' },
                                    { offset: 1, color: 'rgba(76, 175, 80, 0.1)' }
                                ]
                            }
                        },
                        markLine: {
                            data: [
                                { yAxis: initialCash, name: '初始资金', lineStyle: { color: '#999', type: 'dashed' } }
                            ]
                        },
                        markPoint: (buyPoints.length > 0 || sellPoints.length > 0) ? {
                            data: [
                                ...buyPoints,
                                ...sellPoints
                            ],
                            symbol: 'circle',
                            symbolSize: 18,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: function(params) {
                                    return params.data.name || params.name || '';
                                },
                                fontSize: 12,
                                color: '#fff',
                                fontWeight: 'bold',
                                backgroundColor: 'rgba(0, 0, 0, 0.5)',
                                padding: [4, 8],
                                borderRadius: 4
                            },
                            itemStyle: {
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            emphasis: {
                                label: {
                                    show: true
                                },
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowColor: 'rgba(255, 255, 255, 0.5)'
                                }
                            }
                        } : undefined,
                        showSymbol: false
                    },
                    {
                        name: '收益率',
                        type: 'line',
                        yAxisIndex: 1,
                        xAxisIndex: 1,
                        data: returns,
                        smooth: true,
                        lineStyle: { width: 1, color: '#26a69a' },
                        showSymbol: false
                    }
                ]
            };
            
            try {
                console.log('Setting ECharts option with', dates.length, 'data points');
                equityChart.setOption(option, true);  // notMerge=true，完全替换
                console.log('ECharts option set successfully');
                
                // 强制调整大小以确保图表正确显示
                setTimeout(() => {
                    try {
                        if (equityChart && chartElement && chartElement.offsetWidth > 0) {
                            equityChart.resize();
                            console.log('Chart resized after initialization');
                        }
                        // 再次检查图表是否渲染
                        const chartContainer = document.getElementById('resultChart');
                        if (chartContainer) {
                            console.log('Chart container check:', {
                                childrenCount: chartContainer.children.length,
                                offsetWidth: chartContainer.offsetWidth,
                                offsetHeight: chartContainer.offsetHeight
                            });
                            if (chartContainer.children.length === 0) {
                                console.warn('Chart container is still empty after initialization');
                            }
                        }
                    } catch (e) {
                        console.warn('Error in chart resize check:', e);
                    }
                }, 300);
                
                // 添加一个更长的延迟检查，确保图表渲染
                setTimeout(() => {
                    const chartContainer = document.getElementById('resultChart');
                    if (chartContainer) {
                        const canvas = chartContainer.querySelector('canvas');
                        const svg = chartContainer.querySelector('svg');
                        console.log('Chart render check:', {
                            hasCanvas: !!canvas,
                            hasSvg: !!svg,
                            childrenCount: chartContainer.children.length,
                            offsetWidth: chartContainer.offsetWidth,
                            offsetHeight: chartContainer.offsetHeight
                        });
                        
                        if (!canvas && !svg) {
                            console.error('Chart canvas/svg not found! Chart may not have rendered.');
                            chartElement.innerHTML = '<div style="padding: 20px; color: #fff; text-align: center;">警告: 图表未能正确渲染<br/>请检查浏览器控制台是否有错误信息<br/>或刷新页面重试</div>';
                        } else {
                            console.log('Chart canvas/svg found, chart should be visible');
                            // 确保图表可见
                            if (canvas) canvas.style.display = 'block';
                            if (svg) svg.style.display = 'block';
                        }
                    }
                }, 800);
                
                // 处理窗口大小变化
                const resizeHandler = () => {
                    try {
                        const chartContainer = document.getElementById('resultChart');
                        if (equityChart && chartContainer && chartContainer.offsetWidth > 0) {
                            equityChart.resize();
                        }
                    } catch (e) {
                        console.warn('Error in resize handler:', e);
                    }
                };
                // 移除旧的监听器（如果存在）
                if (window.equityChartResizeHandler) {
                    window.removeEventListener('resize', window.equityChartResizeHandler);
                }
                window.equityChartResizeHandler = resizeHandler;
                window.addEventListener('resize', resizeHandler);
                
                console.log('Equity chart initialized successfully with', dates.length, 'data points');
            } catch (e) {
                console.error('Failed to set chart option:', e);
                chartElement.innerHTML = '<div style="padding: 20px; color: #fff;">错误: 图表渲染失败: ' + e.message + '</div>';
            }
        }
    </script>
</body>
</html>

