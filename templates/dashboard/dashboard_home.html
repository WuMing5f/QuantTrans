{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}æ€»è§ˆä»ªè¡¨ç›˜ - é‡åŒ–äº¤æ˜“ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡¶éƒ¨å¡ç‰‡ -->
    <div class="row mb-4">
        <!-- æ€»èµ„äº§ -->
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">æ€»èµ„äº§</h5>
                    <h2 class="mb-0">Â¥{{ total_equity|floatformat:2 }}</h2>
                    <small>æŒä»“å¸‚å€¼ + ç°é‡‘</small>
                </div>
            </div>
        </div>
        
        <!-- ä»Šæ—¥ç›ˆäº -->
        <div class="col-md-3">
            <div class="card text-white {% if today_pnl >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                <div class="card-body">
                    <h5 class="card-title">ä»Šæ—¥ç›ˆäº</h5>
                    <h2 class="mb-0">Â¥{{ today_pnl|floatformat:2 }}</h2>
                    <small>ä»Šæ—¥äº¤æ˜“ç›ˆäº</small>
                </div>
            </div>
        </div>
        
        <!-- æŒä»“é£é™© -->
        <div class="col-md-3">
            <div class="card text-white {% if position_risk > 80 %}bg-danger{% elif position_risk > 60 %}bg-warning{% else %}bg-info{% endif %}">
                <div class="card-body">
                    <h5 class="card-title">å½“å‰ä»“ä½</h5>
                    <h2 class="mb-0">{{ position_risk|floatformat:1 }}%</h2>
                    <small>æŒä»“å¸‚å€¼ / æ€»èµ„äº§</small>
                </div>
            </div>
        </div>
        
        <!-- APIè¿æ¥çŠ¶æ€ -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">APIè¿æ¥çŠ¶æ€</h5>
                    <ul class="list-unstyled mb-0">
                        <li>
                            uSmart: 
                            {% if api_status.usmart %}
                                <span class="badge bg-success">âœ“ æ­£å¸¸</span>
                            {% else %}
                                <span class="badge bg-danger">âœ— æ–­å¼€</span>
                            {% endif %}
                        </li>
                        <li>
                            AkShare: 
                            {% if api_status.akshare %}
                                <span class="badge bg-success">âœ“ æ­£å¸¸</span>
                            {% else %}
                                <span class="badge bg-danger">âœ— æ–­å¼€</span>
                            {% endif %}
                        </li>
                        <li>
                            Redis: 
                            {% if api_status.redis %}
                                <span class="badge bg-success">âœ“ æ­£å¸¸</span>
                            {% else %}
                                <span class="badge bg-warning">âš  æœªè¿æ¥</span>
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç´§æ€¥æŒ‰é’® -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-danger">
                <h5 class="alert-heading">âš ï¸ ç´§æ€¥æ“ä½œ</h5>
                <p>åœ¨ç´§æ€¥æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‰é’®ç«‹å³åœæ­¢ç­–ç•¥æˆ–æ¸…ä»“ï¼š</p>
                <button class="btn btn-danger btn-lg me-2" onclick="emergencyStop()">
                    ğŸ›‘ åœæ­¢æ‰€æœ‰ç­–ç•¥
                </button>
                <button class="btn btn-warning btn-lg" onclick="emergencyLiquidate()">
                    ğŸ’° ä¸€é”®æ¸…ä»“
                </button>
            </div>
        </div>
    </div>
    
    <!-- ä¸»åŠŸèƒ½åŒº -->
    <div class="row">
        <!-- å·¦ä¾§ï¼šæŒä»“åˆ—è¡¨ -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>å½“å‰æŒä»“</h5>
                </div>
                <div class="card-body">
                    {% if positions %}
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ä»£ç </th>
                                    <th>æ•°é‡</th>
                                    <th>æˆæœ¬ä»·</th>
                                    <th>å½“å‰ä»·</th>
                                    <th>ç›ˆäº</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for position in positions %}
                                <tr>
                                    <td>{{ position.symbol }}</td>
                                    <td>{{ position.quantity }}</td>
                                    <td>Â¥{{ position.cost_price|floatformat:2 }}</td>
                                    <td>Â¥{{ position.current_price|floatformat:2 }}</td>
                                    <td class="{% if position.pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        Â¥{{ position.pnl|floatformat:2 }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted">æš‚æ— æŒä»“</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šæœ€è¿‘äº¤æ˜“ -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>æœ€è¿‘äº¤æ˜“</h5>
                </div>
                <div class="card-body">
                    {% if recent_trades %}
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>ç­–ç•¥</th>
                                    <th>æ–¹å‘</th>
                                    <th>ä»·æ ¼</th>
                                    <th>æ•°é‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trade in recent_trades %}
                                <tr>
                                    <td>{{ trade.timestamp|date:"H:i:s" }}</td>
                                    <td>{{ trade.strategy_name }}</td>
                                    <td>
                                        {% if trade.direction == 'BUY' %}
                                            <span class="badge bg-success">ä¹°å…¥</span>
                                        {% else %}
                                            <span class="badge bg-danger">å–å‡º</span>
                                        {% endif %}
                                    </td>
                                    <td>Â¥{{ trade.price|floatformat:2 }}</td>
                                    <td>{{ trade.quantity }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted">æš‚æ— äº¤æ˜“è®°å½•</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function emergencyStop() {
    if (confirm('ç¡®å®šè¦åœæ­¢æ‰€æœ‰ç­–ç•¥å—ï¼Ÿ')) {
        // TODO: è°ƒç”¨APIåœæ­¢ç­–ç•¥
        alert('ç­–ç•¥å·²åœæ­¢');
    }
}

function emergencyLiquidate() {
    if (confirm('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦ä¸€é”®æ¸…ä»“å—ï¼Ÿè¿™å°†å–å‡ºæ‰€æœ‰æŒä»“ï¼')) {
        // TODO: è°ƒç”¨APIæ¸…ä»“
        alert('æ¸…ä»“æŒ‡ä»¤å·²å‘é€');
    }
}
</script>
{% endblock %}

