# 分钟数据获取说明

## 数据源支持情况

### 1. A股ETF分钟数据（akshare）

**好消息**：✅ **akshare支持ETF分钟数据！**

**支持的接口**：
- `ak.fund_etf_hist_min_em` - ETF分钟数据接口

**支持的周期**：
- `"1"` - 1分钟
- `"5"` - 5分钟
- `"15"` - 15分钟
- `"30"` - 30分钟
- `"60"` - 60分钟

**使用示例**：
```python
import akshare as ak
from datetime import datetime, timedelta

# 获取ETF的5分钟数据
end_date = datetime.now()
start_date = end_date - timedelta(days=1)

df = ak.fund_etf_hist_min_em(
    symbol="510300",  # ETF代码
    start_date=start_date.strftime('%Y-%m-%d %H:%M:%S'),
    end_date=end_date.strftime('%Y-%m-%d %H:%M:%S'),
    period="5",  # 5分钟
    adjust="qfq"  # 前复权
)

# 返回的列名（中文）：
# ['时间', '开盘', '收盘', '最高', '最低', '涨跌幅', '涨跌额', '成交量', '成交额', '振幅', '换手率']
```

**注意事项**：
- 需要提供完整的日期时间格式：`'YYYY-MM-DD HH:MM:SS'`
- 数据通常在交易日才有
- 建议获取最近几天的数据（不要一次性获取太长时间的数据）

### 2. 美股分钟数据（yfinance）

**支持情况**：
✅ **yfinance支持分钟级别数据**

**支持的间隔**：
- `1m` - 1分钟
- `2m` - 2分钟
- `5m` - 5分钟
- `15m` - 15分钟
- `30m` - 30分钟
- `60m` - 60分钟
- `90m` - 90分钟
- `1h` - 1小时

**限制**：
- 1分钟数据最多只能获取最近7天的数据
- 2分钟数据最多只能获取最近60天的数据
- 5分钟数据最多只能获取最近60天的数据
- 其他间隔的数据限制较少

**使用示例**：
```python
import yfinance as yf

ticker = yf.Ticker('AAPL')

# 获取1分钟数据（最近7天）
df_1m = ticker.history(interval='1m', period='7d')

# 获取5分钟数据（最近60天）
df_5m = ticker.history(interval='5m', period='60d')

# 获取指定日期范围的分钟数据
df_5m = ticker.history(interval='5m', start='2024-01-01', end='2024-01-31')
```

## 实现方案

### 方案1：扩展现有Provider支持分钟数据

可以修改现有的数据提供者，添加分钟数据获取功能：

```python
def fetch_history_minute(
    self,
    symbol: str,
    start: Union[str, datetime],
    end: Union[str, datetime],
    interval: str = '5m',  # 1m, 5m, 15m, 30m, 60m
    **kwargs
) -> pd.DataFrame:
    """获取分钟级别数据"""
    pass
```

### 方案2：创建新的分钟数据模型

由于分钟数据量很大（每天有240个1分钟K线），需要考虑：

1. **数据存储**：是否需要单独的分钟数据表
2. **数据量**：1年的1分钟数据 = 约60,000条记录
3. **查询性能**：需要合适的索引策略
4. **数据保留**：是否需要保留所有历史分钟数据

### 方案3：实时数据 vs 历史数据

- **实时数据**：需要实时API或WebSocket连接
- **历史数据**：yfinance可以获取，但有限制

## 总结

### ✅ A股ETF分钟数据：**可以获取**
- 使用 `ak.fund_etf_hist_min_em`
- 支持1、5、15、30、60分钟
- 需要提供日期时间范围（格式：'YYYY-MM-DD HH:MM:SS'）

### ✅ 美股分钟数据：**可以获取**
- 使用 yfinance的 `interval` 参数
- 支持1m、5m、15m、30m、60m等
- 1分钟数据最多只能获取最近7天

## 建议

### 对于A股ETF：
1. ✅ **可以使用** `ak.fund_etf_hist_min_em` 获取分钟数据
2. 建议优先使用5分钟或15分钟数据（数据量适中）
3. 注意获取时间范围不要太大，建议按天或按周获取

### 对于美股：
1. ✅ **可以直接实现**分钟数据获取
2. 注意数据量限制（1分钟数据最多7天）
3. 建议优先使用5分钟或15分钟数据

## 数据库设计考虑

如果需要存储分钟数据，建议：

1. **创建新的CandleMinute模型**：
```python
class CandleMinute(models.Model):
    instrument = models.ForeignKey(Instrument, ...)
    datetime = models.DateTimeField(...)  # 包含日期和时间
    open = models.DecimalField(...)
    high = models.DecimalField(...)
    low = models.DecimalField(...)
    close = models.DecimalField(...)
    volume = models.BigIntegerField(...)
    
    class Meta:
        unique_together = [['instrument', 'datetime']]
        indexes = [
            models.Index(fields=['instrument', 'datetime']),
        ]
```

2. **或者使用现有Candle模型**，但需要：
   - 修改date字段为datetime字段
   - 添加interval字段区分不同时间粒度

## 实现方案

### 方案1：扩展现有Provider（推荐）

可以在现有的Provider中添加分钟数据获取方法：

```python
def fetch_history_minute(
    self,
    symbol: str,
    start: Union[str, datetime],
    end: Union[str, datetime],
    interval: str = '5m',  # 5分钟
    **kwargs
) -> pd.DataFrame:
    """获取分钟级别数据"""
    # A股ETF: 使用 ak.fund_etf_hist_min_em
    # 美股: 使用 yfinance的 interval 参数
```

### 方案2：数据库设计

**选项A：使用现有Candle模型（简单）**
- 修改date字段支持datetime
- 添加interval字段区分时间粒度
- 适用于同时存储日线和分钟数据

**选项B：创建新的CandleMinute模型（推荐）**
- 专门存储分钟数据
- 更好的查询性能
- 可以使用分区表优化

### 方案3：数据保留策略

- **1分钟数据**：建议只保留最近30天
- **5分钟数据**：建议保留最近90天
- **15分钟数据**：建议保留最近1年
- **日线数据**：保留所有历史数据

## 下一步行动

如果你想要实现分钟数据功能，我可以：

1. ✅ **已确认akshare支持ETF分钟数据**
2. ✅ **yfinance支持美股分钟数据**
3. **实现分钟数据获取方法**（在Provider中添加）
4. **设计数据库模型**（CandleMinute或扩展Candle）
5. **实现数据同步命令**（支持分钟数据）
6. **更新可视化**（支持分钟K线图）

请告诉我你想要：
- ✅ A股ETF分钟数据（已确认可以获取）
- ✅ 美股分钟数据（已确认可以获取）
- 需要哪些时间间隔？（1分钟、5分钟、15分钟等）
- 数据需要存储多长时间？
- 是否需要我立即实现？

