# 数据获取使用说明

## 数据同步命令使用方法

### 基本语法

```bash
python manage.py sync_data --symbol <代码> --market <市场> --start <开始日期> --end <结束日期> [--name <名称>]
```

### 参数说明

- `--symbol`: 股票代码（必需）
  - 美股：如 `AAPL`, `MSFT`, `TSLA`
  - A股：如 `510300`（ETF代码）
- `--market`: 市场类型（必需）
  - `US`: 美股市场
  - `CN`: A股市场
- `--start`: 开始日期（必需），格式：`YYYY-MM-DD`
- `--end`: 结束日期（必需），格式：`YYYY-MM-DD`
- `--name`: 标的名称（可选），如果不提供则使用代码作为名称

### 使用示例

#### 1. 获取A股ETF数据（推荐先测试）

```bash
# 获取沪深300ETF最近一个月的数据
python manage.py sync_data --symbol 510300 --market CN --start 2023-12-01 --end 2023-12-31 --name "沪深300ETF"

# 获取更多数据
python manage.py sync_data --symbol 510300 --market CN --start 2023-01-01 --end 2023-12-31 --name "沪深300ETF"
```

#### 2. 获取美股数据

```bash
# 获取苹果股票数据
python manage.py sync_data --symbol AAPL --market US --start 2023-12-01 --end 2023-12-31 --name "Apple Inc."

# 获取微软股票数据
python manage.py sync_data --symbol MSFT --market US --start 2023-01-01 --end 2023-12-31 --name "Microsoft Corporation"
```

## 常见问题

### 1. yfinance速率限制问题

**问题现象**：
```
错误: Too Many Requests. Rate limited. Try after a while.
```

**原因**：yfinance（Yahoo Finance）有访问频率限制，短时间内多次请求会被限制。

**解决方案**：
1. **等待一段时间后重试**（推荐）：等待5-10分钟后再次尝试
2. **使用更短的时间范围**：先获取少量数据测试
3. **使用VPN**：更换IP地址可能有助于绕过限制
4. **代码已自动重试**：系统会自动重试3次，每次等待时间递增

**示例**：
```bash
# 先获取最近一周的数据测试
python manage.py sync_data --symbol AAPL --market US --start 2023-12-25 --end 2023-12-31 --name "Apple Inc."
```

### 2. A股数据获取失败

如果A股数据获取失败，可能的原因：
- ETF代码不正确（确保代码存在且可以交易）
- 网络连接问题
- akshare API更新（代码已适配最新API）

**解决方法**：
- 检查ETF代码是否正确（如 `510300`, `159919` 等）
- 确保网络连接正常
- 查看错误信息确定具体问题

### 3. 数据已存在的情况

如果同一个标的和日期的数据已经存在：
- 系统会自动更新现有数据
- 不会创建重复记录

## 验证数据是否获取成功

### 方法1：使用Django Shell

```bash
python manage.py shell
```

```python
from apps.data_master.models import Instrument, Candle

# 查看所有标的
instruments = Instrument.objects.all()
for inst in instruments:
    print(f"{inst.symbol} ({inst.name}) - {inst.market}")

# 查看某个标的的数据
inst = Instrument.objects.get(symbol='510300')
candles = Candle.objects.filter(instrument=inst).order_by('date')
print(f"共 {candles.count()} 条K线数据")

# 查看最近几条数据
for candle in candles[:5]:
    print(f"{candle.date}: 开={candle.open}, 收={candle.close}, 量={candle.volume}")
```

### 方法2：访问Django Admin

```bash
python manage.py createsuperuser  # 如果还没有创建超级用户
python manage.py runserver
```

访问 http://127.0.0.1:8000/admin/ 登录后可以查看和管理数据。

### 方法3：查看Web界面

```bash
python manage.py runserver
```

访问 http://127.0.0.1:8000/ 查看仪表盘，会显示已同步的标的列表。

## 数据格式说明

### K线数据字段

- `date`: 日期
- `open`: 开盘价（4位小数）
- `high`: 最高价（4位小数）
- `low`: 最低价（4位小数）
- `close`: 收盘价（4位小数）
- `volume`: 成交量（整数）
- `amount`: 成交额（2位小数）
- `turnover`: 换手率（%，4位小数，可能为空）

## 数据源说明

### 美股数据源（yfinance）
- **数据提供者**：Yahoo Finance
- **复权方式**：自动复权（auto_adjust=True）
- **数据质量**：较好
- **限制**：有访问频率限制

### A股数据源（akshare）
- **数据提供者**：东方财富
- **复权方式**：前复权（qfq）
- **数据质量**：较好
- **限制**：相对较少，但建议适度使用

## 批量同步数据建议

如果需要同步大量数据：

1. **分批同步**：按时间段分批获取，避免一次性请求过多数据
2. **添加延迟**：可以在脚本中添加时间延迟
3. **优先使用A股**：A股数据源限制较少
4. **错峰使用**：避开网络高峰期

## 下一步

数据同步成功后，你可以：

1. **计算技术指标**：使用 `apps.analysis.indicators.IndicatorEngine`
2. **运行回测**：使用 `apps.backtest.engine.run_backtest`
3. **查看数据**：通过Django Admin或Web界面

