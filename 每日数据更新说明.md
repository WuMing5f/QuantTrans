# 每日数据更新说明

## 数据更新策略

由于yfinance（美股数据源）有严格的访问频率限制，建议采用以下策略：

### 推荐方案

1. **A股ETF数据**（无限制或限制较少）：
   - 可以每天更新
   - 建议使用定时任务（cron）每天收盘后更新

2. **美股数据**（有严格限制）：
   - 建议分批更新，每天更新部分股票
   - 或者使用付费API（如Alpha Vantage）
   - 或者等待速率限制解除后再更新

## 批量同步命令

### 同步A股ETF（推荐每天执行）

```bash
# 同步最近7天的数据
python manage.py batch_sync --type etf --days 7 --delay 2

# 同步最近30天的数据（更完整的历史数据）
python manage.py batch_sync --type etf --days 30 --delay 2
```

### 同步美股（分批或等待限制解除）

```bash
# 尝试同步美股（可能需要等待速率限制解除）
python manage.py batch_sync --type us_stocks --days 7 --delay 10

# 如果遇到速率限制，等待一段时间后重试
```

### 同步所有数据

```bash
python manage.py batch_sync --type all --days 7 --delay 5
```

## 定时任务设置（Linux/macOS）

### 使用cron每天自动更新

1. 编辑crontab：
```bash
crontab -e
```

2. 添加以下任务（每天下午4点更新，假设A股收盘后）：
```bash
# 每天16:00更新A股ETF数据
0 16 * * 1-5 cd /Users/zhiyiwu/Desktop/Coding/AICoding/AIProject/StockTrans && source venv/bin/activate && python manage.py batch_sync --type etf --days 7 --delay 2 >> /tmp/stock_sync.log 2>&1
```

说明：
- `0 16 * * 1-5`：周一到周五的16:00执行
- `>> /tmp/stock_sync.log 2>&1`：将输出写入日志文件

### 手动创建更新脚本

创建一个脚本文件 `update_data.sh`：

```bash
#!/bin/bash
cd /Users/zhiyiwu/Desktop/Coding/AICoding/AIProject/StockTrans
source venv/bin/activate

# 更新A股ETF数据（最近7天）
python manage.py batch_sync --type etf --days 7 --delay 2

# 如果美股速率限制解除，可以取消注释下面的行
# python manage.py batch_sync --type us_stocks --days 7 --delay 10

echo "数据更新完成: $(date)"
```

使用：
```bash
chmod +x update_data.sh
./update_data.sh
```

## Python脚本方式（推荐）

创建 `update_daily.py`：

```python
#!/usr/bin/env python
"""
每日数据更新脚本
建议使用定时任务每天执行一次
"""
import os
import django
import sys
from datetime import datetime

# 设置Django环境
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from django.core.management import call_command

def main():
    print(f"开始每日数据更新: {datetime.now()}")
    
    try:
        # 更新A股ETF数据（最近7天）
        print("正在更新A股ETF数据...")
        call_command('batch_sync', type='etf', days=7, delay=2)
        print("A股ETF数据更新完成")
        
        # 美股数据（如果速率限制解除，可以启用）
        # print("正在更新美股数据...")
        # call_command('batch_sync', type='us_stocks', days=7, delay=10)
        # print("美股数据更新完成")
        
    except Exception as e:
        print(f"更新失败: {str(e)}")
        return 1
    
    print(f"数据更新完成: {datetime.now()}")
    return 0

if __name__ == '__main__':
    sys.exit(main())
```

使用：
```bash
chmod +x update_daily.py
python update_daily.py
```

## 查看更新后的数据

1. **Web界面查看**：
   - 访问：http://127.0.0.1:8000/etf/ 查看ETF概览
   - 访问：http://127.0.0.1:8000/us-stocks/ 查看美股概览

2. **命令行查看**：
```bash
python manage.py shell
```

```python
from apps.data_master.models import Instrument, Candle
from django.db.models import Max

# 查看所有ETF
etfs = Instrument.objects.filter(market='CN')
for etf in etfs:
    latest = Candle.objects.filter(instrument=etf).order_by('-date').first()
    if latest:
        print(f"{etf.symbol} - {etf.name}: 最新价格 {latest.close} ({latest.date})")
```

## 美股数据获取替代方案

如果yfinance限制太严格，可以考虑：

1. **使用Alpha Vantage API**（免费版有限制，付费版更稳定）
2. **使用其他数据源**：如Quandl、Polygon.io等
3. **手动更新**：通过其他工具获取数据后导入

## 注意事项

1. **数据时效性**：
   - 建议在交易日收盘后更新
   - A股：下午3点后
   - 美股：需要根据时区调整

2. **速率限制**：
   - yfinance有严格限制，不要频繁请求
   - 如果遇到限制，等待1-2小时后再试

3. **数据完整性**：
   - 使用`--days`参数控制获取多少天的数据
   - 系统会自动去重，不会创建重复记录

4. **错误处理**：
   - 如果某个标的同步失败，不会影响其他标的
   - 可以稍后单独同步失败的标的

