# 策略回测系统说明

## ✅ 已实现的功能

### 1. 策略库（`apps/backtest/strategies.py`）

已实现6种常用交易策略：

#### 1.1 双均线策略（MACrossStrategy）
- **策略代码**: `macross`
- **策略逻辑**: 当短期均线上穿长期均线时买入，下穿时卖出
- **参数**:
  - `fast_period`: 短期均线周期（默认5）
  - `slow_period`: 长期均线周期（默认20）

#### 1.2 MACD策略（MACDStrategy）
- **策略代码**: `macd`
- **策略逻辑**: 当MACD线上穿信号线时买入，下穿时卖出
- **参数**:
  - `fast_period`: 快速EMA周期（默认12）
  - `slow_period`: 慢速EMA周期（默认26）
  - `signal_period`: 信号线周期（默认9）

#### 1.3 RSI策略（RSIStrategy）
- **策略代码**: `rsi`
- **策略逻辑**: RSI低于超卖线时买入，高于超买线时卖出
- **参数**:
  - `period`: RSI周期（默认14）
  - `oversold`: 超卖阈值（默认30）
  - `overbought`: 超买阈值（默认70）

#### 1.4 布林带策略（BollingerBandsStrategy）
- **策略代码**: `bollinger`
- **策略逻辑**: 价格触及下轨时买入，触及上轨时卖出
- **参数**:
  - `period`: 布林带周期（默认20）
  - `devfactor`: 标准差倍数（默认2.0）

#### 1.5 三均线策略（TripleMAStrategy）
- **策略代码**: `triple_ma`
- **策略逻辑**: 短期均线 > 中期均线 > 长期均线时买入，反之卖出
- **参数**:
  - `fast_period`: 短期均线周期（默认5）
  - `mid_period`: 中期均线周期（默认10）
  - `slow_period`: 长期均线周期（默认20）

#### 1.6 均值回归策略（MeanReversionStrategy）
- **策略代码**: `mean_reversion`
- **策略逻辑**: 当价格偏离均线一定比例时买入/卖出
- **参数**:
  - `period`: 均线周期（默认20）
  - `threshold`: 偏离阈值（默认0.02，即2%）

### 2. 回测引擎（`apps/backtest/engine.py`）

- **功能**: 使用Backtrader引擎运行回测
- **支持的分析指标**:
  - 总收益率
  - 年化收益率
  - 夏普比率
  - 最大回撤
  - 最大回撤持续时间

### 3. Web界面

- **访问地址**: http://127.0.0.1:8000/backtest/
- **功能**:
  - 选择标的（ETF或股票）
  - 选择策略
  - 设置回测参数（日期范围、初始资金、手续费率）
  - 自定义策略参数
  - 查看回测结果（统计指标）

## 📊 使用方法

### 通过Web界面

1. 访问回测页面：http://127.0.0.1:8000/backtest/
2. 选择要回测的标的（代码）
3. 选择策略
4. 设置回测参数：
   - 开始日期
   - 结束日期
   - 初始资金（默认10万）
   - 手续费率（默认0.1%）
5. 根据需要调整策略参数
6. 点击"开始回测"按钮
7. 查看回测结果

### 通过Python代码

```python
from apps.backtest.engine import run_backtest

# 运行双均线策略回测
result = run_backtest(
    symbol='510300',
    strategy_name='macross',
    start_date='2023-01-01',
    end_date='2024-12-31',
    initial_cash=100000,
    commission=0.001,
    fast_period=5,
    slow_period=20
)

print(f"总收益率: {result['total_return']:.2f}%")
print(f"最终价值: {result['final_value']:.2f}")
print(f"夏普比率: {result['sharpe_ratio']:.3f}")
```

## 🔧 添加新策略

1. 在 `apps/backtest/strategies.py` 中创建策略类，继承 `bt.Strategy`
2. 实现策略逻辑（`next` 方法）
3. 在 `STRATEGY_REGISTRY` 中注册策略
4. 在 `apps/dashboard/views.py` 的 `backtest_view` 函数中添加策略信息

示例：

```python
class MyStrategy(bt.Strategy):
    params = (
        ('param1', 10),
        ('printlog', False),
    )
    
    def __init__(self):
        # 初始化指标
        pass
    
    def next(self):
        # 策略逻辑
        if not self.position:
            if 买入条件:
                self.buy()
        else:
            if 卖出条件:
                self.sell()

# 注册策略
STRATEGY_REGISTRY['my_strategy'] = MyStrategy
```

## 📈 回测结果说明

- **初始资金**: 回测开始时的资金
- **最终价值**: 回测结束时的资产总值
- **总收益率**: (最终价值 - 初始资金) / 初始资金 * 100%
- **年化收益率**: 年化的收益率
- **最大回撤**: 从峰值到谷值的最大跌幅
- **夏普比率**: 风险调整后的收益率（>1较好，>2优秀）

## ⚠️ 注意事项

1. 确保标的已有足够的历史数据（建议至少1年）
2. 手续费率会影响回测结果，应根据实际情况设置
3. 不同策略适合不同的市场环境，建议多策略对比
4. 回测结果不代表未来表现，仅供参考

## 🎯 下一步优化方向

1. 添加策略组合回测
2. 添加参数优化功能（网格搜索）
3. 添加收益曲线图表
4. 添加交易记录详情
5. 添加多标的批量回测
6. 添加策略对比功能

